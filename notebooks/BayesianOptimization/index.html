<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Download BayesianOptimization.ipynb notebook from IPython.core.display import display, HTML import warnings display(HTML(&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;)) warnings.simplefilter(&#34;ignore&#34;) &lt;IPython.core.display.HTML object&gt;  import matplotlib.pyplot as plt import numpy as np import pandas as pd from scipy.stats import t Bayesian Optimization This notebook demonstrates the basic principles of Bayesian Optimization (BO) and how to use MLOS to perform BO.
Motivation In software performance engineering, the impact different (input) parameters (e.g. buffer size, worker thread count, etc.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="" />
<meta property="og:description" content="Download BayesianOptimization.ipynb notebook from IPython.core.display import display, HTML import warnings display(HTML(&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;)) warnings.simplefilter(&#34;ignore&#34;) &lt;IPython.core.display.HTML object&gt;  import matplotlib.pyplot as plt import numpy as np import pandas as pd from scipy.stats import t Bayesian Optimization This notebook demonstrates the basic principles of Bayesian Optimization (BO) and how to use MLOS to perform BO.
Motivation In software performance engineering, the impact different (input) parameters (e.g. buffer size, worker thread count, etc." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://microsoft.github.io/MLOS/notebooks/BayesianOptimization/" />

<title>Bayesian Optimization | MLOS</title>
<link rel="manifest" href="/MLOS/manifest.json">
<link rel="icon" href="/MLOS/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/MLOS/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css" integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY=">
<script defer src="/MLOS/en.search.min.ffbd932e21b2ff27e24603e9deb482e98a5721b780a70e45742ba9df48114df9.js" integrity="sha256-/72TLiGy/yfiRgPp3rSC6YpXIbeApw5FdCup30gRTfk="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/MLOS"><span>MLOS</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  <ul>
<li>
<p><a href="/MLOS/documentation/">Documentation</a></p>
<ul>
<li><a href="/MLOS/documentation/01-Prerequisites/">Prerequisites</a></li>
<li><a href="/MLOS/documentation/02-Build/">Build</a></li>
<li><a href="/MLOS/documentation/04-Test/">Test</a></li>
<li><a href="/MLOS/documentation/CodingStandard/">Coding Standard</a></li>
<li><a href="/MLOS/documentation/MlosArchitecture/">Architecture</a></li>
<li><a href="/MLOS/documentation/RepoOrganization/">Repo Organization</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/notebooks/">Notebooks</a></p>
<ul>
<li><a href="/MLOS/notebooks/BayesianOptimization/"class=active>Bayesian Optimization</a></li>
<li><a href="/MLOS/notebooks/SmartCacheOptimization/">Smart Cache Optimization</a></li>
<li><a href="/MLOS/notebooks/SmartCacheCPP/">Smart Cache Optimization in C++</a></li>
<li><a href="/MLOS/notebooks/LevelDbTuning/">LevelDB External Tuning Example</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/source/Examples/">E2E Examples</a></p>
<ul>
<li><a href="/MLOS/source/Examples/SmartCache/">Smart Cache</a></li>
</ul>
</li>
<li>
<p>API Documentation</p>
<ul>
<li><a href="/MLOS/python_api/">Python</a></li>
</ul>
</li>
<li>
<p>Component Documentation</p>
<ul>
<li><a href="/MLOS/source/Mlos.SettingsSystem.CodeGen/">Mlos Settings System Code Generation System</a></li>
<li><a href="/MLOS/source/Mlos.Core/doc/">Mlos.Core Shared Memory Communication Channel</a></li>
<li><a href="/MLOS/source/Mlos.Agent.Server/">Mlos.Agent.Server</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/external/">External Integration</a></p>
</li>
<li>
<p><a href="/MLOS/CODE_OF_CONDUCT/">Code of Conduct</a></p>
</li>
<li>
<p><a href="/MLOS/CONTRIBUTING/">Contributing</a></p>
</li>
<li>
<p><a href="https://github.com/Microsoft/MLOS">MLOS Github Repository</a></p>
</li>
</ul>










</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/MLOS/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Bayesian Optimization</strong>

  <label for="toc-control">
    
    <img src="/MLOS/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#motivation">Motivation</a></li>
    <li><a href="#a-synthetic-example">A synthetic example</a></li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="download-bayesianoptimizationipynb-notebookhttpsrawgithubusercontentcommicrosoftmlosmainsourcemlosnotebooksbayesianoptimizationipynb"><a href="https://raw.githubusercontent.com/microsoft/MLOS/main/source/Mlos.Notebooks/BayesianOptimization.ipynb">Download BayesianOptimization.ipynb notebook</a></h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> IPython.core.display <span style="color:#f92672">import</span> display, HTML
<span style="color:#f92672">import</span> warnings
display(HTML(<span style="color:#e6db74">&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;</span>))
warnings<span style="color:#f92672">.</span>simplefilter(<span style="color:#e6db74">&#34;ignore&#34;</span>)
</code></pre></div><pre><code>&lt;IPython.core.display.HTML object&gt;
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">from</span> scipy.stats <span style="color:#f92672">import</span> t
</code></pre></div><h1 id="bayesian-optimization">Bayesian Optimization</h1>
<p>This notebook demonstrates the basic principles of <a href="https://en.wikipedia.org/wiki/Bayesian_optimization">Bayesian Optimization (BO)</a> and how to use MLOS to perform BO.</p>
<h2 id="motivation">Motivation</h2>
<p>In software performance engineering, the impact different (input) parameters (e.g. buffer size, worker thread count, etc.) can have on the (output) performance of a system for a given workload (input) can be modeled as a multidimensional function - one which we don&rsquo;t know the equation for apriori, but are instead trying to learn through careful sampling of the input space and experimentation (test/benchmark runs) to gather output points.
Bayesian optimization is one technique for efficiently selecting the samples in the input space to learn the approximate shape of that function and find its optimum, i.,e. the parameters that lead to the best performance.
In this example we use a synthetic (i.e. made-up) function that we can look at directly to stand in for a complex system with unknown characteristics.</p>
<p>Bayesian Optimization is a <a href="https://en.wikipedia.org/wiki/Global_optimization">global optimization</a> strategy, so a way to find the global optimum of a mathematical function that&rsquo;s not necessarily <a href="https://en.wikipedia.org/wiki/Convex_function">convex</a>. BO is a black-box optimization technique, meaning that it requires only function values and no other information like gradients.</p>
<p>This is in contrast to other optimization strategies, such as gradient descent or conjugate gradient that require gradients and are only guaranteed to find a local optimum (if the function is assumed to be convex, this is also the global optimum).</p>
<p>Finding the global optimum of a general non-convex function is NP-hard, which makes it impossible to provide effective convergence guarantees for any global optimization strategy, including Bayesian Optimization. However, BO has been found to be quite effective in the past.</p>
<h2 id="a-synthetic-example">A synthetic example</h2>
<p>Let&rsquo;s take a simple synthetic example of a one-dimensional function that we assume is unknown.
If we actually had access to the function, we could use more efficient techniques using calculus and would not be using Bayesian Optimization.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># define fake performance function</span>
<span style="color:#75715e"># In an actual application, we would not have access to this function directly.</span>
<span style="color:#75715e"># Instead, we could only measure the outcome by running an experiment, such as timing</span>
<span style="color:#75715e"># a particular run of the system.</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">f</span>(x):
    <span style="color:#66d9ef">return</span> (<span style="color:#ae81ff">6</span><span style="color:#f92672">*</span>x<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>np<span style="color:#f92672">.</span>sin(<span style="color:#ae81ff">12</span><span style="color:#f92672">*</span>x<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>)
</code></pre></div><p>In a real use case for global optimization, the function we want to optimize is usually only implicitly defined and very expensive to compute, such as training and evaluating a neural network, or timing the run of a large workload on a distributed database. Given the cost of evaluating the function, our goal is to find an optimum while keeping the number of function evaluations to a minimum.</p>
<p>In this synthetic example, we actually know the function, so we can just plot it for illustration purposes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># define a domain to evaluate</span>
line <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>)
<span style="color:#75715e"># evaluate function</span>
values <span style="color:#f92672">=</span> f(line)
<span style="color:#75715e"># plot function</span>
plt<span style="color:#f92672">.</span>plot(line, values)
plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#34;Input (parameter)&#34;</span>)
plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#34;Objective (i.e. performance)&#34;</span>)
</code></pre></div><pre><code>Text(0,0.5,'Objective (i.e. performance)')
</code></pre>
<p><img src="/MLOS/notebooks/BayesianOptimization_files/BayesianOptimization_8_1.png" alt="png" /></p>
<p>Our goal here is to find the global minimum of this function, assuming that we don&rsquo;t have direct access to the formula (given the formula, we could instead calculate the optimum quite precicely using methods from calculus instead). Usually, the function is too expensive to evaluate in such a manner, in particular in higher-dimensional spaces.</p>
<p>Now, we use MLOS to construct an OptimizationProblem object that will encapsulate the function and the input space.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> mlos.Optimizers.OptimizationProblem <span style="color:#f92672">import</span> OptimizationProblem, Objective
<span style="color:#f92672">from</span> mlos.Optimizers.BayesianOptimizer <span style="color:#f92672">import</span> BayesianOptimizer
<span style="color:#f92672">from</span> mlos.Spaces <span style="color:#f92672">import</span> SimpleHypergrid, ContinuousDimension

<span style="color:#75715e"># single continuous input dimension between 0 and 1</span>
input_space <span style="color:#f92672">=</span> SimpleHypergrid(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;input&#34;</span>, dimensions<span style="color:#f92672">=</span>[ContinuousDimension(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;x&#34;</span>, min<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, max<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)])
<span style="color:#75715e"># define output space, we might not know the exact ranges</span>
output_space <span style="color:#f92672">=</span> SimpleHypergrid(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;objective&#34;</span>,
                               dimensions<span style="color:#f92672">=</span>[ContinuousDimension(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;function_value&#34;</span>, min<span style="color:#f92672">=-</span><span style="color:#ae81ff">10</span>, max<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)])

<span style="color:#75715e"># define optimization problem with input and output space and objective</span>
optimization_problem <span style="color:#f92672">=</span> OptimizationProblem(
    parameter_space<span style="color:#f92672">=</span>input_space,
    objective_space<span style="color:#f92672">=</span>output_space,
    <span style="color:#75715e"># we want to minimize the function</span>
    objectives<span style="color:#f92672">=</span>[Objective(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;function_value&#34;</span>, minimize<span style="color:#f92672">=</span>True)]
)
</code></pre></div><p>The way Bayesian Optimization (in particular what is known as sequential model-based optimization) works is by iterating the following steps:</p>
<ul>
<li>Evaluate the function at a candidate point x_i (start with a random point x_0), observe f(x_i).</li>
<li>Build / update a <strong>surrogate model</strong> g_i of the objective function (here a Random Forest) using the pairs x_i, f(x_i) that we observed so far.</li>
<li>Pick the next data point to evaluate based on the updated model g_i using a criterion known as <strong>acquisition function</strong>.</li>
</ul>
<p>The idea is that eventually the surrogate model will provide a good approximation of the objective function, but it will be much faster to evaluate (i.e. by predicting with a Random Forest or Gaussian process or another trained machine learning model, instead of running a complex deployment). The acquisition function serves as a means to trade off exploration vs exploitation in collecting new data for building the surrogate model: it picks points that have a low (close to optimum) value of the surrogate model (and so are expected to have a low value of the actual objective). This is the &ldquo;exploitation&rdquo; of existing knowledge in the model. On the other hand, it also encourages exploring new areas in which there is a lot of uncertainty in the surrogate model, i.e. where we expect the surrogate model not to be very acurate yet.</p>
<p>This process is coordinated by the <code>BayesianOptimizer</code> object, which we will use to perform Bayesian Optimization with a random forest surrogate model. Details of this particular method can be found in <a href="https://www.cs.ubc.ca/~hutter/papers/11-LION5-SMAC.pdf">Hutter et. al. (2011)</a>. We&rsquo;re first configuring the model to refit after every iteration and use 10 trees for the random forest:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> mlos.Optimizers.BayesianOptimizerConfigStore <span style="color:#f92672">import</span> bayesian_optimizer_config_store
<span style="color:#f92672">from</span> mlos.Optimizers.BayesianOptimizerFactory <span style="color:#f92672">import</span> BayesianOptimizerFactory
<span style="color:#f92672">from</span> mlos.Spaces <span style="color:#f92672">import</span> Point

<span style="color:#75715e"># configure the optimizer, start from the default configuration</span>
optimizer_config <span style="color:#f92672">=</span> bayesian_optimizer_config_store<span style="color:#f92672">.</span>default
<span style="color:#75715e"># set the fraction of randomly sampled configuration to 10% of suggestions</span>
optimizer_config<span style="color:#f92672">.</span>experiment_designer_config<span style="color:#f92672">.</span>fraction_random_suggestions <span style="color:#f92672">=</span> <span style="color:#f92672">.</span><span style="color:#ae81ff">1</span>
<span style="color:#75715e"># configure the random forest surrogate model</span>
random_forest_config <span style="color:#f92672">=</span> optimizer_config<span style="color:#f92672">.</span>homogeneous_random_forest_regression_model_config
<span style="color:#75715e"># refit the model after each observation</span>
random_forest_config<span style="color:#f92672">.</span>decision_tree_regression_model_config<span style="color:#f92672">.</span>n_new_samples_before_refit <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
<span style="color:#75715e"># Use the best split in trees (not random as in extremely randomized trees)</span>
random_forest_config<span style="color:#f92672">.</span>decision_tree_regression_model_config<span style="color:#f92672">.</span>splitter <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;best&#39;</span>
<span style="color:#75715e"># right now we&#39;re sampling without replacement so we need to subsample</span>
<span style="color:#75715e"># to make the trees different when using the &#39;best&#39; splitter</span>
random_forest_config<span style="color:#f92672">.</span>samples_fraction_per_estimator <span style="color:#f92672">=</span> <span style="color:#f92672">.</span><span style="color:#ae81ff">9</span>
<span style="color:#75715e"># Use 10 trees in the random forest (usually more are better, 10 makes it run pretty quickly)</span>
random_forest_config<span style="color:#f92672">.</span>n_estimators <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
<span style="color:#75715e"># Set multiplier for the confidence bound</span>
optimizer_config<span style="color:#f92672">.</span>experiment_designer_config<span style="color:#f92672">.</span>confidence_bound_utility_function_config<span style="color:#f92672">.</span>alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>

optimizer_factory <span style="color:#f92672">=</span> BayesianOptimizerFactory()
optimizer <span style="color:#f92672">=</span> optimizer_factory<span style="color:#f92672">.</span>create_local_optimizer(
    optimization_problem<span style="color:#f92672">=</span>optimization_problem,
    optimizer_config<span style="color:#f92672">=</span>optimizer_config
)
</code></pre></div><pre><code>09/26/2020 19:29:36 -   BayesianOptimizerFactory -    INFO - [BayesianOptimizerFactory.py:  41 -    create_local_optimizer() ] Creating a bayesian optimizer with config: {
  &quot;surrogate_model_implementation&quot;: &quot;HomogeneousRandomForestRegressionModel&quot;,
  &quot;experiment_designer_implementation&quot;: &quot;ExperimentDesigner&quot;,
  &quot;min_samples_required_for_guided_design_of_experiments&quot;: 10,
  &quot;homogeneous_random_forest_regression_model_config.n_estimators&quot;: 10,
  &quot;homogeneous_random_forest_regression_model_config.features_fraction_per_estimator&quot;: 1,
  &quot;homogeneous_random_forest_regression_model_config.samples_fraction_per_estimator&quot;: 0.9,
  &quot;homogeneous_random_forest_regression_model_config.regressor_implementation&quot;: &quot;DecisionTreeRegressionModel&quot;,
  &quot;homogeneous_random_forest_regression_model_config.decision_tree_regression_model_config.criterion&quot;: &quot;mse&quot;,
  &quot;homogeneous_random_forest_regression_model_config.decision_tree_regression_model_config.splitter&quot;: &quot;best&quot;,
  &quot;homogeneous_random_forest_regression_model_config.decision_tree_regression_model_config.max_depth&quot;: 0,
  &quot;homogeneous_random_forest_regression_model_config.decision_tree_regression_model_config.min_samples_split&quot;: 2,
  &quot;homogeneous_random_forest_regression_model_config.decision_tree_regression_model_config.min_samples_leaf&quot;: 3,
  &quot;homogeneous_random_forest_regression_model_config.decision_tree_regression_model_config.min_weight_fraction_leaf&quot;: 0,
  &quot;homogeneous_random_forest_regression_model_config.decision_tree_regression_model_config.max_features&quot;: &quot;auto&quot;,
  &quot;homogeneous_random_forest_regression_model_config.decision_tree_regression_model_config.max_leaf_nodes&quot;: 0,
  &quot;homogeneous_random_forest_regression_model_config.decision_tree_regression_model_config.min_impurity_decrease&quot;: 0,
  &quot;homogeneous_random_forest_regression_model_config.decision_tree_regression_model_config.ccp_alpha&quot;: 0,
  &quot;homogeneous_random_forest_regression_model_config.decision_tree_regression_model_config.min_samples_to_fit&quot;: 10,
  &quot;homogeneous_random_forest_regression_model_config.decision_tree_regression_model_config.n_new_samples_before_refit&quot;: 1,
  &quot;homogeneous_random_forest_regression_model_config.bootstrap&quot;: 1,
  &quot;experiment_designer_config.utility_function_implementation&quot;: &quot;ConfidenceBoundUtilityFunction&quot;,
  &quot;experiment_designer_config.numeric_optimizer_implementation&quot;: &quot;RandomSearchOptimizer&quot;,
  &quot;experiment_designer_config.confidence_bound_utility_function_config.utility_function_name&quot;: &quot;upper_confidence_bound_on_improvement&quot;,
  &quot;experiment_designer_config.confidence_bound_utility_function_config.alpha&quot;: 0.1,
  &quot;experiment_designer_config.random_search_optimizer_config.num_samples_per_iteration&quot;: 1000,
  &quot;experiment_designer_config.fraction_random_suggestions&quot;: 0.5,
  &quot;experiment_designer_config_fraction_random_suggestions&quot;: 0.1
}.
</code></pre>
<p>Now, we can run the actual optimization which will carry out the steps outlined above.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_optimization</span>(optimizer):
    <span style="color:#75715e"># suggest new value from optimizer</span>
    suggested_value <span style="color:#f92672">=</span> optimizer<span style="color:#f92672">.</span>suggest()
    input_values_df <span style="color:#f92672">=</span> suggested_value<span style="color:#f92672">.</span>to_dataframe()
    <span style="color:#75715e"># suggested value are dictionary-like, keys are input space parameter names</span>
    <span style="color:#75715e"># evaluate target function</span>
    target_value <span style="color:#f92672">=</span> f(suggested_value[<span style="color:#e6db74">&#39;x&#39;</span>])
    <span style="color:#66d9ef">print</span>(suggested_value<span style="color:#f92672">.</span>to_json(), target_value)
    
    <span style="color:#75715e"># build dataframes to </span>
    target_values_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#39;function_value&#39;</span>: [target_value]})

    optimizer<span style="color:#f92672">.</span>register(input_values_df, target_values_df)

<span style="color:#75715e"># run for some iterations</span>
n_iterations <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n_iterations):
    run_optimization(optimizer)
</code></pre></div><pre><code>{&quot;x&quot;: 0.983092543436823} 15.17416093448022
{&quot;x&quot;: 0.8435385550792688} -1.4996779115157042
{&quot;x&quot;: 0.23007923495667082} -0.36288334233535546
{&quot;x&quot;: 0.15719066911289126} -0.9563346460889276
{&quot;x&quot;: 0.520939819354775} 0.9848498586246127
{&quot;x&quot;: 0.19141441981931262} -0.7187454908362136
{&quot;x&quot;: 0.8582062972543654} 0.15163828039842148
{&quot;x&quot;: 0.15134098015340036} -0.9751882528295707
{&quot;x&quot;: 0.11781845586576145} -0.8816797092480978
{&quot;x&quot;: 0.5836141907587765} 0.31070790925443953
{&quot;x&quot;: 0.686066698158629} -3.97383368468424
{&quot;x&quot;: 0.6204630856295394} -0.888327556915524
{&quot;x&quot;: 0.5350401764159637} 0.9670120759968829
{&quot;x&quot;: 0.7463592300760595} -5.959462466805426
{&quot;x&quot;: 0.9057244430736491} 6.518041099261522
</code></pre>
<p>You can see that the hit rate is not always increasing, and that is for two reasons: first, the optimizer keeps exploring parts of the space in which there is uncertainty. Second, by default the BayesianOptimizer picks a fraction of points at random to increase exploration. This fraction is set as <code>optimizer_config.experiment_designer_config_fraction_random_suggestions = .1</code> above.</p>
<p>After 15 iterations, the model is likely to have captured the general shape, but probably not have found the actual optimum:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># evaluate the surrogate</span>
<span style="color:#75715e">#</span>
surrogate_predictions <span style="color:#f92672">=</span> optimizer<span style="color:#f92672">.</span>predict(pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#39;x&#39;</span>: line}))<span style="color:#f92672">.</span>get_dataframe()

<span style="color:#75715e"># plot observations</span>
<span style="color:#75715e">#</span>
feature_values, target_values, _ <span style="color:#f92672">=</span> optimizer<span style="color:#f92672">.</span>get_all_observations()
plt<span style="color:#f92672">.</span>scatter(feature_values, target_values, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;observed points&#39;</span>)

<span style="color:#75715e"># plot true function (usually unknown)</span>
<span style="color:#75715e">#</span>
plt<span style="color:#f92672">.</span>plot(line, values, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true function&#39;</span>)

<span style="color:#75715e"># plot the surrogate</span>
<span style="color:#75715e">#</span>
alpha <span style="color:#f92672">=</span> optimizer_config<span style="color:#f92672">.</span>experiment_designer_config<span style="color:#f92672">.</span>confidence_bound_utility_function_config<span style="color:#f92672">.</span>alpha
t_values <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span>ppf(<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> alpha <span style="color:#f92672">/</span> <span style="color:#ae81ff">2.0</span>, surrogate_predictions[<span style="color:#e6db74">&#39;predicted_value_degrees_of_freedom&#39;</span>])
ci_radii <span style="color:#f92672">=</span> t_values <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>sqrt(surrogate_predictions[<span style="color:#e6db74">&#39;predicted_value_variance&#39;</span>])
value <span style="color:#f92672">=</span> surrogate_predictions[<span style="color:#e6db74">&#39;predicted_value&#39;</span>]
plt<span style="color:#f92672">.</span>plot(line, value, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;surrogate predictions g&#39;</span>)
plt<span style="color:#f92672">.</span>fill_between(line, value <span style="color:#f92672">-</span> ci_radii, value <span style="color:#f92672">+</span> ci_radii, alpha<span style="color:#f92672">=.</span><span style="color:#ae81ff">1</span>)
plt<span style="color:#f92672">.</span>plot(line, <span style="color:#f92672">-</span>optimizer<span style="color:#f92672">.</span>experiment_designer<span style="color:#f92672">.</span>utility_function(optimization_problem<span style="color:#f92672">.</span>construct_feature_dataframe(pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#39;x&#39;</span>: line}))), <span style="color:#e6db74">&#39;:&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utility_function&#39;</span>)
plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#34;Objective function f (performance)&#34;</span>)
plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#34;Input variable&#34;</span>)
plt<span style="color:#f92672">.</span>legend()
</code></pre></div><pre><code>&lt;matplotlib.legend.Legend at 0x1fbe2a58b00&gt;
</code></pre>
<p><img src="/MLOS/notebooks/BayesianOptimization_files/BayesianOptimization_18_1.png" alt="png" /></p>
<p>We can find the best value according to the current surrogate with the <code>optimum</code> method:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">optimizer<span style="color:#f92672">.</span>optimum()
</code></pre></div><pre><code>({
   &quot;x&quot;: 0.7463592300760595
 }, {
   &quot;function_value&quot;: -5.959462466805426
 })
</code></pre>
<p>We can run more iterations to improve the surrogate model and the optimum that is found:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># run for more iterations</span>
n_iterations <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n_iterations):
    run_optimization(optimizer)
</code></pre></div><pre><code>{&quot;x&quot;: 0.473412447846017} 0.7021164245077595
{&quot;x&quot;: 0.6632242079785616} -2.8567197230243733
{&quot;x&quot;: 0.18807256140072703} -0.7483728822439081
{&quot;x&quot;: 0.4172371207492612} 0.21419007910211812
{&quot;x&quot;: 0.4946267758016123} 0.8749554960705916
{&quot;x&quot;: 0.6175708715122464} -0.7737011075417488
{&quot;x&quot;: 0.7443496510664342} -5.935312134676282
{&quot;x&quot;: 0.7439459529541941} -5.930000321904706
{&quot;x&quot;: 0.3767786032488877} 0.033842030625167815
{&quot;x&quot;: 0.3298466838855343} -1.8305512156868478e-05
{&quot;x&quot;: 0.14169507729653608} -0.9862030605731403
{&quot;x&quot;: 0.2111860703491355} -0.5341585508413712
{&quot;x&quot;: 0.7596100164652652} -6.017742850545829
{&quot;x&quot;: 0.8006992516779171} -4.9126248393567495
{&quot;x&quot;: 0.8109406889057383} -4.305536957072894
{&quot;x&quot;: 0.8181655852320083} -3.7961625204914613
{&quot;x&quot;: 0.2566480065634811} -0.16845997730008264
{&quot;x&quot;: 0.22836320880807248} -0.37762613491139096
{&quot;x&quot;: 0.8234842634097982} -3.378993806987811
{&quot;x&quot;: 0.1136365546027639} -0.8410156758386963
{&quot;x&quot;: 0.8515058915961442} -0.6289596894583336
{&quot;x&quot;: 0.5864306840092383} 0.2403755540305389
{&quot;x&quot;: 0.6530665956022451} -2.3573665797713597
{&quot;x&quot;: 0.6289697629244638} -1.2427732828786415
{&quot;x&quot;: 0.8239417825768095} -3.341461632283429
{&quot;x&quot;: 0.7333477284034062} -5.738233990022671
{&quot;x&quot;: 0.8315754575407727} -2.6775285696863467
{&quot;x&quot;: 0.5222880051350126} 0.9858420597039397
{&quot;x&quot;: 0.11642041423252358} -0.8688859210021689
{&quot;x&quot;: 0.4472894351503083} 0.4578657933743529
{&quot;x&quot;: 0.8527127293048408} -0.49149171666093044
{&quot;x&quot;: 0.7779341551755734} -5.779966997170833
{&quot;x&quot;: 0.7452511869304634} -5.946620760879891
{&quot;x&quot;: 0.5559819176453921} 0.8079207413333107
{&quot;x&quot;: 0.7494998662235278} -5.9894045479395
{&quot;x&quot;: 0.7139893782357419} -5.161987725383618
{&quot;x&quot;: 0.846796666877744} -1.15152680830581
{&quot;x&quot;: 0.6879805421463292} -4.063990746002142
{&quot;x&quot;: 0.7905230980834056} -5.381732629200189
{&quot;x&quot;: 0.4816517251028316} 0.7747029205006717
{&quot;x&quot;: 0.692753881917271} -4.284669550477883
{&quot;x&quot;: 0.9929490981264024} 15.633823386883824
{&quot;x&quot;: 0.7489069999749162} -5.984492737405131
{&quot;x&quot;: 0.7379839661326224} -5.834196772620266
{&quot;x&quot;: 0.7201435179072647} -5.372952605375765
{&quot;x&quot;: 0.8297734821402678} -2.840599351113572
{&quot;x&quot;: 0.14807885573973778} -0.9818647703658573
{&quot;x&quot;: 0.32904609824262243} -3.4027030163747833e-05
{&quot;x&quot;: 0.009055711748202966} 2.579698434938776
{&quot;x&quot;: 0.6368149488510908} -1.590145461988316
</code></pre>
<p>There is some improvement in the optimum:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">best_observation_config, best_observation_value <span style="color:#f92672">=</span> optimizer<span style="color:#f92672">.</span>optimum()
<span style="color:#66d9ef">print</span>(best_observation_config<span style="color:#f92672">.</span>to_json())
<span style="color:#66d9ef">print</span>(best_observation_value<span style="color:#f92672">.</span>to_json())
</code></pre></div><pre><code>{&quot;x&quot;: 0.7596100164652652}
{&quot;function_value&quot;: -6.017742850545829}
</code></pre>
<p>We can now visualize the surrogate model and optimization process again. The points are colored according to the iteration number, with dark blue points being early in the process and yellow points being later. You can see that at the end of the optimization, the points start to cluster around the optimum.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># evaluate the surrogate</span>
<span style="color:#75715e">#</span>
surrogate_predictions <span style="color:#f92672">=</span> optimizer<span style="color:#f92672">.</span>predict(pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#39;x&#39;</span>: line}))<span style="color:#f92672">.</span>get_dataframe()

<span style="color:#75715e"># plot observations</span>
<span style="color:#75715e">#</span>
feature_values, target_values <span style="color:#f92672">=</span> optimizer<span style="color:#f92672">.</span>get_all_observations()
plt<span style="color:#f92672">.</span>scatter(feature_values, target_values, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;observed points&#39;</span>)
 
<span style="color:#75715e"># plot true function (usually unknown)</span>
<span style="color:#75715e">#</span>
plt<span style="color:#f92672">.</span>plot(line, values, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;true function&#39;</span>)

<span style="color:#75715e"># plot the surrogate</span>
<span style="color:#75715e">#</span>
alpha <span style="color:#f92672">=</span> optimizer_config<span style="color:#f92672">.</span>experiment_designer_config<span style="color:#f92672">.</span>confidence_bound_utility_function_config<span style="color:#f92672">.</span>alpha
t_values <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span>ppf(<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> alpha <span style="color:#f92672">/</span> <span style="color:#ae81ff">2.0</span>, surrogate_predictions[<span style="color:#e6db74">&#39;predicted_value_degrees_of_freedom&#39;</span>])
ci_radii <span style="color:#f92672">=</span> t_values <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>sqrt(surrogate_predictions[<span style="color:#e6db74">&#39;predicted_value_variance&#39;</span>])
value <span style="color:#f92672">=</span> surrogate_predictions[<span style="color:#e6db74">&#39;predicted_value&#39;</span>]
plt<span style="color:#f92672">.</span>plot(line, value, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;surrogate predictions g&#39;</span>)
plt<span style="color:#f92672">.</span>fill_between(line, value <span style="color:#f92672">-</span> ci_radii, value <span style="color:#f92672">+</span> ci_radii, alpha<span style="color:#f92672">=.</span><span style="color:#ae81ff">1</span>)

plt<span style="color:#f92672">.</span>plot(line, <span style="color:#f92672">-</span>optimizer<span style="color:#f92672">.</span>experiment_designer<span style="color:#f92672">.</span>utility_function(pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#39;x&#39;</span>: line})), <span style="color:#e6db74">&#39;:&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utility_function&#39;</span>)
ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>gca()
ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;Objective function f&#34;</span>)
ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#34;Input variable&#34;</span>)
bins_axes <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>twinx()
bins_axes<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;Points sampled&#34;</span>)
feature_values<span style="color:#f92672">.</span>hist(bins<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, ax<span style="color:#f92672">=</span>bins_axes, alpha<span style="color:#f92672">=.</span><span style="color:#ae81ff">3</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;k&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;count of querry points&#34;</span>)
plt<span style="color:#f92672">.</span>legend()
</code></pre></div><pre><code>&lt;matplotlib.legend.Legend at 0x1fbe2a26828&gt;
</code></pre>
<p><img src="/MLOS/notebooks/BayesianOptimization_files/BayesianOptimization_26_1.png" alt="png" /></p>
<h1 id="going-further">Going further:</h1>
<ol>
<li>
<p>Plot the optimum as a function of iterations. How long does it take for the optimization to converge? Is that stable over several random restarts?</p>
</li>
<li>
<p>Does changing the search to a purely random search (setting <code>optimizer_config.experiment_designer_config_fraction_random_suggestions = 1</code>) change how long the optimization takes to find the optimum?</p>
</li>
</ol>
<h1 id="download-bayesianoptimizationipynb-notebookhttpsrawgithubusercontentcommicrosoftmlosmainsourcemlosnotebooksbayesianoptimizationipynb-1"><a href="https://raw.githubusercontent.com/microsoft/MLOS/main/source/Mlos.Notebooks/BayesianOptimization.ipynb">Download BayesianOptimization.ipynb notebook</a></h1>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#motivation">Motivation</a></li>
    <li><a href="#a-synthetic-example">A synthetic example</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












