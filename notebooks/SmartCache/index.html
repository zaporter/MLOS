<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Goal The goal of this notebook is to optimize SmartCache.
from IPython.core.display import display, HTML display(HTML(&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;)) TODO Lots to do here.
For once - this is probably not the workflow we want. We likely want to:
 Start the Optimizer in a separate process so that we can monitor its progress. Maybe we should have a separate notebook just for Optimizer Monitoring. Start the Mlos.Agent &#43; Workload in a separate process.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="" />
<meta property="og:description" content="Goal The goal of this notebook is to optimize SmartCache.
from IPython.core.display import display, HTML display(HTML(&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;)) TODO Lots to do here.
For once - this is probably not the workflow we want. We likely want to:
 Start the Optimizer in a separate process so that we can monitor its progress. Maybe we should have a separate notebook just for Optimizer Monitoring. Start the Mlos.Agent &#43; Workload in a separate process." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://microsoft.github.io/MLOS/notebooks/SmartCache/" />

<title>Smart Cache | MLOS</title>
<link rel="manifest" href="/MLOS/manifest.json">
<link rel="icon" href="/MLOS/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/MLOS/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css" integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY=">
<script defer src="/MLOS/en.search.min.3a35a1b2be706d655924c771dd01edbf1952a2dd77db8e464953103ebeffaa35.js" integrity="sha256-OjWhsr5wbWVZJMdx3QHtvxlSot13245GSVMQPr7/qjU="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/MLOS"><span>MLOS</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  <ul>
<li>
<p><a href="/MLOS/documentation/">Documentation</a></p>
<ul>
<li><a href="/MLOS/documentation/01-Prerequisites/">Prerequisits</a></li>
<li><a href="/MLOS/documentation/02-Build/">Build</a></li>
<li><a href="/MLOS/documentation/05-Test/">Test</a></li>
<li><a href="/MLOS/documentation/CodingStandard/">Coding Standard</a></li>
<li><a href="/MLOS/documentation/MlosArchitecture/">Architecture</a></li>
<li><a href="/MLOS/documentation/RepoOrganization/">Repo Organization</a></li>
</ul>
</li>
<li>
<p>Notebooks</p>
<ul>
<li><a href="/MLOS/notebooks/StartHere/">Start Here</a></li>
<li><a href="/MLOS/notebooks/SmartCache/"class=active>Smart Cache</a></li>
<li><a href="/MLOS/notebooks/OptimizerMonitor/">Optimizer Monitor</a></li>
</ul>
</li>
<li>
<p>API Documentation</p>
<ul>
<li><a href="/MLOS/python_api/">Python</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/CODE_OF_CONDUCT/">Code of Conduct</a></p>
</li>
<li>
<p><a href="/MLOS/CONTRIBUTING/">Contributing</a></p>
</li>
</ul>










</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/MLOS/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Smart Cache</strong>

  <label for="toc-control">
    
    <img src="/MLOS/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents"></nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="goal">Goal</h1>
<p>The goal of this notebook is to optimize SmartCache.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> IPython.core.display <span style="color:#f92672">import</span> display, HTML
display(HTML(<span style="color:#e6db74">&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;</span>))
</code></pre></div><h1 id="todo">TODO</h1>
<p>Lots to do here.</p>
<p>For once - this is probably not the workflow we want. We likely want to:</p>
<ol>
<li><!-- raw HTML omitted -->Start the Optimizer in a separate process so that we can monitor its progress. Maybe we should have a separate notebook just for Optimizer Monitoring.<!-- raw HTML omitted --></li>
<li>Start the Mlos.Agent + Workload in a separate process. Perhaps communicate with them over gRPC. This would bring us closer to the C# scenario but is not a top priority.</li>
<li>We need to be able to see how well the cache is doing: what are its stats.</li>
<li>We want to modify the workload so that one configuration dominates.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor
<span style="color:#f92672">import</span> os
<span style="color:#f92672">from</span> subprocess <span style="color:#f92672">import</span> Popen, CREATE_NEW_CONSOLE
<span style="color:#f92672">import</span> sys
<span style="color:#f92672">from</span> threading <span style="color:#f92672">import</span> Thread

<span style="color:#f92672">import</span> grpc
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> mlos.Grpc.BayesianOptimizerFactory <span style="color:#f92672">import</span> BayesianOptimizerFactory
<span style="color:#f92672">from</span> mlos.Grpc.BayesianOptimizerProxy <span style="color:#f92672">import</span> BayesianOptimizerProxy
<span style="color:#f92672">from</span> mlos.Grpc.OptimizerMonitor <span style="color:#f92672">import</span> OptimizerMonitor

<span style="color:#f92672">from</span> mlos.Logger <span style="color:#f92672">import</span> create_logger

<span style="color:#f92672">from</span> mlos.Examples.SmartCache <span style="color:#f92672">import</span> SmartCacheWorkloadGenerator, SmartCache
<span style="color:#f92672">from</span> mlos.Examples.SmartCache.TelemetryAggregators.WorkingSetSizeEstimator <span style="color:#f92672">import</span> WorkingSetSizeEstimator

<span style="color:#f92672">from</span> mlos.Grpc.OptimizerMicroserviceServer <span style="color:#f92672">import</span> OptimizerMicroserviceServer

<span style="color:#f92672">from</span> mlos.Mlos.Infrastructure <span style="color:#f92672">import</span> CommunicationChannel, SharedConfig
<span style="color:#f92672">from</span> mlos.Mlos.SDK <span style="color:#f92672">import</span> mlos_globals, MlosGlobalContext, MlosExperiment, MlosAgent
<span style="color:#f92672">from</span> mlos.Mlos.SDK.CommonAggregators.Timer <span style="color:#f92672">import</span> Timer

<span style="color:#f92672">from</span> mlos.Optimizers.BayesianOptimizer <span style="color:#f92672">import</span> BayesianOptimizerConfig
<span style="color:#f92672">from</span> mlos.Optimizers.OptimizationProblem <span style="color:#f92672">import</span> OptimizationProblem, Objective
<span style="color:#f92672">from</span> mlos.Spaces <span style="color:#f92672">import</span> Point, SimpleHypergrid, ContinuousDimension

<span style="color:#f92672">import</span> mlos.global_values <span style="color:#f92672">as</span> global_values

grpc_port <span style="color:#f92672">=</span> <span style="color:#ae81ff">50051</span>
mlos_python_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>getcwd(), <span style="color:#e6db74">&#34;..&#34;</span>, <span style="color:#e6db74">&#34;Mlos.Python&#34;</span>))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">os<span style="color:#f92672">.</span>getpid()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Let&#39;s stand up the Optimizer Service</span>
<span style="color:#75715e">#</span>
python_path <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>executable
optimizer_microservice_launcher_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(mlos_python_path, <span style="color:#e6db74">&#34;mlos&#34;</span>, <span style="color:#e6db74">&#34;start_optimizer_microservice.py&#34;</span>))

command <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#34;{python_path} {optimizer_microservice_launcher_path} launch --port {grpc_port}&#34;</span>
<span style="color:#66d9ef">print</span>(command)
server_process <span style="color:#f92672">=</span> Popen(command, creationflags<span style="color:#f92672">=</span>CREATE_NEW_CONSOLE)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">logger <span style="color:#f92672">=</span> create_logger(<span style="color:#e6db74">&#39;Optimizing Smart Cache&#39;</span>)
optimizer_service_grpc_channel <span style="color:#f92672">=</span> grpc<span style="color:#f92672">.</span>insecure_channel(f<span style="color:#e6db74">&#39;localhost:{grpc_port}&#39;</span>)
bayesian_optimizer_factory <span style="color:#f92672">=</span> BayesianOptimizerFactory(grpc_channel<span style="color:#f92672">=</span>optimizer_service_grpc_channel, logger<span style="color:#f92672">=</span>logger)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Optimization Problem</span>
<span style="color:#75715e">#</span>
optimization_problem <span style="color:#f92672">=</span> OptimizationProblem(
    parameter_space<span style="color:#f92672">=</span>SmartCache<span style="color:#f92672">.</span>parameter_search_space,
    objective_space<span style="color:#f92672">=</span>SimpleHypergrid(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;objectives&#34;</span>, dimensions<span style="color:#f92672">=</span>[ContinuousDimension(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;miss_rate&#34;</span>, min<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, max<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)]),
    context_space<span style="color:#f92672">=</span>None, <span style="color:#75715e"># TODO add the working set size estimators.</span>
    objectives<span style="color:#f92672">=</span>[Objective(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;miss_rate&#34;</span>, minimize<span style="color:#f92672">=</span>True)]
)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">optimizer <span style="color:#f92672">=</span> bayesian_optimizer_factory<span style="color:#f92672">.</span>create_remote_optimizer(
    optimization_problem<span style="color:#f92672">=</span>optimization_problem,
    optimizer_config<span style="color:#f92672">=</span>BayesianOptimizerConfig<span style="color:#f92672">.</span>DEFAULT
)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Now onto the mlos global context - this is where the smart component can send its telemetry and check for new config.</span>
<span style="color:#75715e"># Note that the communication channel and shared config are - well - shared between mlos agent and the smart component.</span>
<span style="color:#75715e">#</span>
global_values<span style="color:#f92672">.</span>declare_singletons()
communication_channel <span style="color:#f92672">=</span> CommunicationChannel()
shared_config <span style="color:#f92672">=</span> SharedConfig()
mlos_globals<span style="color:#f92672">.</span>init_mlos_global_context()
mlos_globals<span style="color:#f92672">.</span>mlos_global_context <span style="color:#f92672">=</span> MlosGlobalContext(communication_channel<span style="color:#f92672">=</span>communication_channel, shared_config<span style="color:#f92672">=</span>shared_config)
<span style="color:#75715e"># Now let&#39;s create the MlosAgent. Note that this architecture mirrors our native architecture, except it&#39;s much less performant.</span>
<span style="color:#75715e">#</span>

mlos_agent <span style="color:#f92672">=</span> MlosAgent(
    logger<span style="color:#f92672">=</span>logger,
    communication_channel<span style="color:#f92672">=</span>communication_channel,
    shared_config<span style="color:#f92672">=</span>shared_config,
    mlos_service_endpoint<span style="color:#f92672">=</span>None, <span style="color:#75715e"># TODO: remove this completely from everywhere.</span>
    bayesian_optimizer_grpc_channel<span style="color:#f92672">=</span>optimizer_service_grpc_channel
)

mlos_agent_thread <span style="color:#f92672">=</span> Thread(target<span style="color:#f92672">=</span>mlos_agent<span style="color:#f92672">.</span>run)
mlos_agent_thread<span style="color:#f92672">.</span>start()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Let&#39;s register SmartCache as a legal smart component.</span>
<span style="color:#75715e">#</span>
mlos_agent<span style="color:#f92672">.</span>add_allowed_component_type(SmartCache)
mlos_agent<span style="color:#f92672">.</span>add_allowed_component_type(SmartCacheWorkloadGenerator) <span style="color:#75715e"># TODO: for the very first exercise we should have a fixed workload.</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">smart_cache_workload <span style="color:#f92672">=</span> SmartCacheWorkloadGenerator(logger<span style="color:#f92672">=</span>logger)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Here we define the telemetry aggregators used in the experiments.</span>
<span style="color:#75715e">#</span>
working_set_size_estimator <span style="color:#f92672">=</span> WorkingSetSizeEstimator()


<span style="color:#75715e"># TODO: this should be yet another telemetry aggregator, not a standalone function.</span>
<span style="color:#75715e">#</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_new_cache_configuration</span>(elapsed_time_ms):
    <span style="color:#75715e"># TODO: remove the globals.</span>
    <span style="color:#66d9ef">global</span> logger
    <span style="color:#66d9ef">global</span> working_set_size_estimator
    <span style="color:#66d9ef">global</span> optimizer
    <span style="color:#66d9ef">global</span> mlos_agent
    
    <span style="color:#75715e"># Just to make sure the optimizer monitor and the tomograph are working: let&#39;s register some dummy results.</span>
    <span style="color:#75715e"># TODO: aggregate telemetry to determine the true miss rate for this cache for a given config.</span>
    <span style="color:#75715e">#</span>
    existing_config <span style="color:#f92672">=</span> mlos_agent<span style="color:#f92672">.</span>get_configuration(component_type<span style="color:#f92672">=</span>SmartCache)
    <span style="color:#66d9ef">if</span> existing_config <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
        features_df <span style="color:#f92672">=</span> existing_config<span style="color:#f92672">.</span>to_pandas()

        <span style="color:#66d9ef">if</span> existing_config<span style="color:#f92672">.</span>implementation <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;MRU&#34;</span>:
            miss_rate <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1000</span> <span style="color:#f92672">+</span> existing_config<span style="color:#f92672">.</span>mru_cache_config<span style="color:#f92672">.</span>cache_size
        <span style="color:#66d9ef">else</span>:
            miss_rate <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span> <span style="color:#f92672">+</span> existing_config<span style="color:#f92672">.</span>lru_cache_config<span style="color:#f92672">.</span>cache_size

        objectives_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#39;miss_rate&#39;</span>: [miss_rate]})
        optimizer<span style="color:#f92672">.</span>register(features_df, objectives_df)    
    
    <span style="color:#75715e"># TODO: have the working set size estimate be part of the context passed to the optimizer.</span>
    <span style="color:#75715e">#</span>
    current_estimate <span style="color:#f92672">=</span> working_set_size_estimator<span style="color:#f92672">.</span>estimate_working_set_size()
    logger<span style="color:#f92672">.</span>info(f<span style="color:#e6db74">&#34;Estimated working set size: {current_estimate.chapman_estimator}&#34;</span>)
    
    new_config_values <span style="color:#f92672">=</span> optimizer<span style="color:#f92672">.</span>suggest()
    mlos_agent<span style="color:#f92672">.</span>set_configuration(
    component_type<span style="color:#f92672">=</span>SmartCache,
        new_config_values<span style="color:#f92672">=</span>new_config_values
    )
    

<span style="color:#75715e"># TODO: we need aggregators to spit out hit rate, as well as other Cache Info (cache entry staleness, cache saturation, etc.)</span>

cache_config_timer <span style="color:#f92672">=</span> Timer(
    timeout_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>,
    observer_callback<span style="color:#f92672">=</span>set_new_cache_configuration
)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Now finally we build the experiment.</span>
<span style="color:#75715e">#</span>
smart_cache_experiment <span style="color:#f92672">=</span> MlosExperiment(
    smart_component_types<span style="color:#f92672">=</span>[SmartCache],
    telemetry_aggregators<span style="color:#f92672">=</span>[cache_config_timer, working_set_size_estimator]
)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># We have the experiment, let&#39;s start it.</span>
<span style="color:#75715e">#</span>
smart_cache_workload_thread <span style="color:#f92672">=</span> Thread(target<span style="color:#f92672">=</span>smart_cache_workload<span style="color:#f92672">.</span>run, args<span style="color:#f92672">=</span>(<span style="color:#ae81ff">150</span>,))
smart_cache_workload_thread<span style="color:#f92672">.</span>start()
mlos_agent<span style="color:#f92672">.</span>start_experiment(smart_cache_experiment)

smart_cache_workload_thread<span style="color:#f92672">.</span>join()
mlos_agent<span style="color:#f92672">.</span>stop_experiment(smart_cache_experiment)
mlos_globals<span style="color:#f92672">.</span>mlos_global_context<span style="color:#f92672">.</span>stop_clock()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Clean up</span>
<span style="color:#75715e">#</span>
mlos_globals<span style="color:#f92672">.</span>mlos_global_context<span style="color:#f92672">.</span>stop_clock()
mlos_agent<span style="color:#f92672">.</span>stop_all()

</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Kill the server.</span>
<span style="color:#75715e">#</span>
server_process<span style="color:#f92672">.</span>kill()
</code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents"></nav>

 
    </aside>
    
  </main>

  
</body>

</html>












