<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="SmartCache Example This SmartCache example is a C&#43;&#43; implementation of the Python SmartCache.
It implements a simple cache with different replacement policies and cache size as built-in tunables and some simple workloads.
It can be used to demonstrate a full end-to-end MLOS integrated microbenchmark for a &ldquo;smart&rdquo; component (in this case a cache).
Contents  SmartCache Example  Contents Building  Linux Windows   Executing  Without an optimizer  Linux Windows Example output   With an optimizer  Example output     Explanation See Also    Building See Also">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://microsoft.github.io/MLOS/source/Examples/SmartCache/" />

<title>Smart Cache | MLOS</title>
<link rel="manifest" href="/MLOS/manifest.json">
<link rel="icon" href="/MLOS/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/MLOS/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css" integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY=">
<script defer src="/MLOS/en.search.min.a8b562ed762012adb05ca46b05f05c9636762e9f903d1ff2c9acccdb0928e46f.js" integrity="sha256-qLVi7XYgEq2wXKRrBfBcljZ2Lp&#43;QPR/yyazM2wko5G8="></script>
<link rel="alternate" type="application/rss+xml" href="https://microsoft.github.io/MLOS/source/Examples/SmartCache/index.xml" title="MLOS" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/MLOS"><span>MLOS</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  <ul>
<li>
<p><a href="/MLOS/documentation/">Documentation</a></p>
<ul>
<li><a href="/MLOS/documentation/01-Prerequisites/">Prerequisites</a></li>
<li><a href="/MLOS/documentation/02-Build/">Build</a></li>
<li><a href="/MLOS/documentation/04-Test/">Test</a></li>
<li><a href="/MLOS/documentation/CodingStandard/">Coding Standard</a></li>
<li><a href="/MLOS/documentation/MlosArchitecture/">Architecture</a></li>
<li><a href="/MLOS/documentation/RepoOrganization/">Repo Organization</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/notebooks/">Notebooks</a></p>
<ul>
<li><a href="/MLOS/notebooks/BayesianOptimization/">Bayesian Optimization</a></li>
<li><a href="/MLOS/notebooks/SmartCacheOptimization/">Smart Cache Optimization</a></li>
<li><a href="/MLOS/notebooks/SmartCacheCPP/">Smart Cache Optimization in C++</a></li>
<li><a href="/MLOS/notebooks/LevelDbTuning/">LevelDB External Tuning Example</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/source/Examples/">E2E Examples</a></p>
<ul>
<li><a href="/MLOS/source/Examples/SmartCache/"class=active>Smart Cache</a></li>
</ul>
</li>
<li>
<p>API Documentation</p>
<ul>
<li><a href="/MLOS/python_api/">Python</a></li>
</ul>
</li>
<li>
<p>Component Documentation</p>
<ul>
<li><a href="/MLOS/source/Mlos.SettingsSystem.CodeGen/">Mlos Settings System Code Generation System</a></li>
<li><a href="/MLOS/source/Mlos.Core/doc/">Mlos.Core Shared Memory Communication Channel</a></li>
<li><a href="/MLOS/source/Mlos.Agent.Server/">Mlos.Agent.Server</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/external/">External Integration</a></p>
</li>
<li>
<p><a href="/MLOS/CODE_OF_CONDUCT/">Code of Conduct</a></p>
</li>
<li>
<p><a href="/MLOS/CONTRIBUTING/">Contributing</a></p>
</li>
<li>
<p><a href="https://github.com/Microsoft/MLOS">MLOS Github Repository</a></p>
</li>
</ul>










</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/MLOS/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Smart Cache</strong>

  <label for="toc-control">
    
    <img src="/MLOS/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#contents">Contents</a></li>
    <li><a href="#building">Building</a>
      <ul>
        <li><a href="#linux">Linux</a></li>
        <li><a href="#windows">Windows</a></li>
      </ul>
    </li>
    <li><a href="#executing">Executing</a>
      <ul>
        <li><a href="#without-an-optimizer">Without an optimizer</a></li>
        <li><a href="#with-an-optimizer">With an optimizer</a></li>
      </ul>
    </li>
    <li><a href="#explanation">Explanation</a></li>
    <li><a href="#see-also">See Also</a></li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="smartcache-examplehttpsgithubcommicrosoftmlostreemainsourceexamplessmartcache"><a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/">SmartCache Example</a></h1>
<p>This <a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/"><code>SmartCache</code></a> example is a C++ implementation of the <a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/../../Mlos.Python/mlos/Examples/SmartCache/">Python SmartCache</a>.</p>
<p>It implements a simple cache with different replacement policies and cache size as built-in tunables and some simple workloads.</p>
<p>It can be used to demonstrate a full end-to-end MLOS integrated microbenchmark for a &ldquo;smart&rdquo; component (in this case a cache).</p>
<h2 id="contents">Contents</h2>
<ul>
<li><a href="#smartcache-example">SmartCache Example</a>
<ul>
<li><a href="#contents">Contents</a></li>
<li><a href="#building">Building</a>
<ul>
<li><a href="#linux">Linux</a></li>
<li><a href="#windows">Windows</a></li>
</ul>
</li>
<li><a href="#executing">Executing</a>
<ul>
<li><a href="#without-an-optimizer">Without an optimizer</a>
<ul>
<li><a href="#linux-1">Linux</a></li>
<li><a href="#windows-1">Windows</a></li>
<li><a href="#example-output">Example output</a></li>
</ul>
</li>
<li><a href="#with-an-optimizer">With an optimizer</a>
<ul>
<li><a href="#example-output-1">Example output</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#explanation">Explanation</a></li>
<li><a href="#see-also">See Also</a></li>
</ul>
</li>
</ul>
<h2 id="building">Building</h2>
<p>See Also</p>
<ul>
<li>General <a href="/MLOS/source/Examples/SmartCache/../../../documentation/02-Build/">build</a> instructions</li>
</ul>
<blockquote>
<p>Note: these commands are given relative to the root of the MLOS repo.</p>
</blockquote>
<h3 id="linux">Linux</h3>
<blockquote>
<p>You can <a href="/MLOS/source/Examples/SmartCache/../../../documentation/01-Prerequisites/#build-the-docker-image">pull or build the Docker image</a> using the
<a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/../../../Dockerfile"><code>Dockerfile</code></a> at the root of the repository to get a Linux build environment.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">make -C source/Mlos.Agent.Server
make -C source/Examples/SmartCache all install
</code></pre></div><blockquote>
<p>The <code>install</code> target places the output in the more convenient <code>target/bin/...</code> path.</p>
</blockquote>
<h3 id="windows">Windows</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">msbuild /m /r source/Mlos.Agent.Server/Mlos.Agent.Server.csproj
msbuild /m /r source/Examples/SmartCache/SmartCache.vcxproj
</code></pre></div><h2 id="executing">Executing</h2>
<h3 id="without-an-optimizer">Without an optimizer</h3>
<h4 id="linux-1">Linux</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">dotnet target/bin/Release/Mlos.Agent.Server.dll <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --settings-registry-path target/bin/Release/AnyCPU <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --experiment target/bin/Release/AnyCPU/SmartCache.ExperimentSession/SmartCache.ExperimentSession.dll <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --executable target/bin/Release/x86_64/SmartCache
</code></pre></div><h4 id="windows-1">Windows</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">dotnet target/bin/Release/Mlos.Agent.Server.dll \
    --settings-registry-path target/bin/Release/AnyCPU \
    --experiment target/bin/Release/AnyCPU/SmartCache.ExperimentSession/SmartCache.ExperimentSession.dll \
    --executable target/bin/Release/x64/SmartCache.exe
</code></pre></div><h4 id="example-output">Example output</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">Mlos.Agent.Server
Starting target/bin/Release/x86_64/SmartCache
observations: 0
info: Microsoft.Hosting.Lifetime[0]
      Now listening on: http://localhost:5000
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /src/MLOS
Starting Mlos.Agent
Found settings registry assembly at target/bin/Release/AnyCPU/SmartCache.SettingsRegistry.dll
observations: 1
observations: 2
observations: 3
...
</code></pre></div><h3 id="with-an-optimizer">With an optimizer</h3>
<p>The examples above merely communicate the SmartCache&rsquo;s progress with the external agent using shared memory.</p>
<p>To also have the SmartCache tune itself by connecting to an optimizer we need to</p>
<ol>
<li>
<p>Start an optimizer:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">start_optimizer_microservice launch --port <span style="color:#ae81ff">50051</span>
</code></pre></div><blockquote>
<p>This assumes that the <code>mlos</code> module has already been installed and is available on the command search <code>PATH</code> environment variable.</p>
<p>See the <a href="/MLOS/source/Examples/SmartCache/../../../documentation/01-Prerequisites/#python-quickstart">Python Quickstart documentation</a> for details.</p>
</blockquote>
</li>
<li>
<p>Add <code>--optimizer-uri http://localhost:50051</code> to the set of arguments to the command above.</p>
</li>
</ol>
<h4 id="example-output-1">Example output</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">dotnet target/bin/Release/AnyCPU/Mlos.Agent.Server/Mlos.Agent.Server.dll <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --executable target/bin/Release/x86_64/SmartCache <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --settings-registry-path target/bin/Release/AnyCPU <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --experiment target/bin/Release/AnyCPU/SmartCache.ExperimentSession/SmartCache.ExperimentSession.dll <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --optimizer-uri http://localhost:50051

<span style="color:#e6db74">```</span>txt
Mlos.Agent.Server
Connecting to the Mlos.Optimizer
Starting target/bin/Release/x86_64/SmartCache
observations: <span style="color:#ae81ff">0</span>
info: Microsoft.Hosting.Lifetime<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
      Now listening on: http://<span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:5000
info: Microsoft.Hosting.Lifetime<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>
      Content root path: /src/MLOS
Starting Mlos.Agent
Waiting <span style="color:#66d9ef">for</span> Mlos.Agent to exit
Found settings registry assembly at target/bin/Release/AnyCPU/SmartCache.SettingsRegistry.dll
Waiting <span style="color:#66d9ef">for</span> agent to respond with a new configuration.
Register <span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;cache_implementation&#34;</span>: <span style="color:#e6db74">&#34;LeastRecentlyUsed&#34;</span>,
  <span style="color:#e6db74">&#34;lru_cache_config.cache_size&#34;</span>: <span style="color:#ae81ff">100</span>
<span style="color:#f92672">}</span> HitRate <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
Suggest False <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;cache_implementation&#34;</span>: <span style="color:#e6db74">&#34;LeastRecentlyUsed&#34;</span>, <span style="color:#e6db74">&#34;lru_cache_config.cache_size&#34;</span>: 747<span style="color:#f92672">}</span>
observations: <span style="color:#ae81ff">1</span>
Waiting <span style="color:#66d9ef">for</span> agent to respond with a new configuration.
Register <span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;cache_implementation&#34;</span>: <span style="color:#e6db74">&#34;LeastRecentlyUsed&#34;</span>,
  <span style="color:#e6db74">&#34;lru_cache_config.cache_size&#34;</span>: <span style="color:#ae81ff">747</span>
<span style="color:#f92672">}</span> HitRate <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
Suggest False <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;cache_implementation&#34;</span>: <span style="color:#e6db74">&#34;MostRecentlyUsed&#34;</span>, <span style="color:#e6db74">&#34;mru_cache_config.cache_size&#34;</span>: 2554<span style="color:#f92672">}</span>
observations: <span style="color:#ae81ff">2</span>
...
</code></pre></div><h2 id="explanation">Explanation</h2>
<p>The <code>Mlos.Agent</code> that gets started by the <code>Mlos.Agent.Server</code> waits for a signal that the component (<code>SmartCache</code>) has connected to the shared memory region before starting to poll the component for messages to process.
This is important in case the component is started independently.</p>
<p>In this case, <code>Mlos.Agent.Server</code> itself starts the component.</p>
<p>Once started, <code>SmartCache</code> will attempt to register its component specific set of shared memory messages with the <code>Mlos.Agent</code> in the <code>Mlos.Agent.Server</code> using <code>RegisterComponentConfig</code> and <code>RegisterAssemblyRequestMessage</code> from <code>Mlos.Core</code> and <code>Mlos.NetCore</code>.
That includes the name of the <code>SettingsRegistry</code> assembly (<code>.dll</code>) corresponding to that component&rsquo;s settings/messages.</p>
<p>The <code>Mlos.Agent.Server</code> needs to be told where it can find those assemblies in order to load them so that it can parse the messages sent by the component.
To do that, we use the <code>--settings-registry-path</code> option.
We also need to provide the path to a corresponding <code>ExperimentSession</code> dll in the <code>--experiment</code> option in order to tell the agent how to process those messages for this experiment.</p>
<p>In the second example we also tell the <code>Mlos.Agent.Server</code> how to connect to the (Python) MLOS Optimizer Service over GRPC so that the application message handlers setup by the <code>SmartCache.SettingsRegistry</code> for the agent can request new configuration recommendations on behalf of the application.</p>
<p>For additional details, see:</p>
<ul>
<li><a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/../../Mlos.Agent.Server/MlosAgentServer.cs">Mlos.Agent.Server/MlosAgentServer.cs</a></li>
<li><a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/Main.cpp">SmartCache/Main.cpp</a></li>
<li><a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/SmartCache.ExperimentSession/SmartCacheExperimentSession.cs">SmartCache.ExperimentSession/SmartCacheExperimentSession.cs</a></li>
<li><a href="https://github.com/microsoft/MLOS/tree/main/source/Examples/SmartCache/SmartCache.SettingsRegistry/Codegen/SmartCache.cs">SmartCache.SettingsRegistry/Codegen/SmartCache.cs</a></li>
</ul>
<h2 id="see-also">See Also</h2>
<p>For additional implementation details and demonstration code, please see the <a href="https://microsoft.github.io/MLOS/notebooks/SmartCacheCPP">SmartCache CPP Notebook</a></p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#contents">Contents</a></li>
    <li><a href="#building">Building</a>
      <ul>
        <li><a href="#linux">Linux</a></li>
        <li><a href="#windows">Windows</a></li>
      </ul>
    </li>
    <li><a href="#executing">Executing</a>
      <ul>
        <li><a href="#without-an-optimizer">Without an optimizer</a></li>
        <li><a href="#with-an-optimizer">With an optimizer</a></li>
      </ul>
    </li>
    <li><a href="#explanation">Explanation</a></li>
    <li><a href="#see-also">See Also</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












