<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Shared Channel Scaleout Document contains results of the improvement in the shared communication channel. We specifically address lack of the scalability issue. The channel does not scale well with increasing number of readers and writers operating on the same channel instance.
Benchmark The benchmark is implemented in Mlos.NetCore.Benchmark project
Benchmark:
 $(MLOSROOT)\MLOS\out\obj\Source\Mlos.NetCore.Benchmark\obj\amd64\Mlos.NetCore.Benchmark.exe -i &ndash;filter SharedChannelReaderScaleOutBenchmarks
 Results Hyper-threading is disabled.
 Intel E5-2670 v3 @ 2.30 GHz:    ReaderCount Mean[B] Mean[I] Error[B] Error[I] StdDev[B] StdDev[I] Allocated     1 830.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="" />
<meta property="og:description" content="Shared Channel Scaleout Document contains results of the improvement in the shared communication channel. We specifically address lack of the scalability issue. The channel does not scale well with increasing number of readers and writers operating on the same channel instance.
Benchmark The benchmark is implemented in Mlos.NetCore.Benchmark project
Benchmark:
 $(MLOSROOT)\MLOS\out\obj\Source\Mlos.NetCore.Benchmark\obj\amd64\Mlos.NetCore.Benchmark.exe -i &ndash;filter SharedChannelReaderScaleOutBenchmarks
 Results Hyper-threading is disabled.
 Intel E5-2670 v3 @ 2.30 GHz:    ReaderCount Mean[B] Mean[I] Error[B] Error[I] StdDev[B] StdDev[I] Allocated     1 830." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://microsoft.github.io/MLOS/source/Mlos.NetCore/Doc/SharedChannelScaleout/" />

<title>Shared Channel Scaleout | MLOS</title>
<link rel="manifest" href="/MLOS/manifest.json">
<link rel="icon" href="/MLOS/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/MLOS/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css" integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY=">
<script defer src="/MLOS/en.search.min.a8b562ed762012adb05ca46b05f05c9636762e9f903d1ff2c9acccdb0928e46f.js" integrity="sha256-qLVi7XYgEq2wXKRrBfBcljZ2Lp&#43;QPR/yyazM2wko5G8="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/MLOS"><span>MLOS</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  <ul>
<li>
<p><a href="/MLOS/documentation/">Documentation</a></p>
<ul>
<li><a href="/MLOS/documentation/01-Prerequisites/">Prerequisites</a></li>
<li><a href="/MLOS/documentation/02-Build/">Build</a></li>
<li><a href="/MLOS/documentation/04-Test/">Test</a></li>
<li><a href="/MLOS/documentation/CodingStandard/">Coding Standard</a></li>
<li><a href="/MLOS/documentation/MlosArchitecture/">Architecture</a></li>
<li><a href="/MLOS/documentation/RepoOrganization/">Repo Organization</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/notebooks/">Notebooks</a></p>
<ul>
<li><a href="/MLOS/notebooks/BayesianOptimization/">Bayesian Optimization</a></li>
<li><a href="/MLOS/notebooks/SmartCacheOptimization/">Smart Cache Optimization</a></li>
<li><a href="/MLOS/notebooks/SmartCacheCPP/">Smart Cache Optimization in C++</a></li>
<li><a href="/MLOS/notebooks/LevelDbTuning/">LevelDB External Tuning Example</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/source/Examples/">E2E Examples</a></p>
<ul>
<li><a href="/MLOS/source/Examples/SmartCache/">Smart Cache</a></li>
</ul>
</li>
<li>
<p>API Documentation</p>
<ul>
<li><a href="/MLOS/python_api/">Python</a></li>
</ul>
</li>
<li>
<p>Component Documentation</p>
<ul>
<li><a href="/MLOS/source/Mlos.SettingsSystem.CodeGen/">Mlos Settings System Code Generation System</a></li>
<li><a href="/MLOS/source/Mlos.Core/doc/">Mlos.Core Shared Memory Communication Channel</a></li>
<li><a href="/MLOS/source/Mlos.Agent.Server/">Mlos.Agent.Server</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/external/">External Integration</a></p>
</li>
<li>
<p><a href="/MLOS/CODE_OF_CONDUCT/">Code of Conduct</a></p>
</li>
<li>
<p><a href="/MLOS/CONTRIBUTING/">Contributing</a></p>
</li>
<li>
<p><a href="https://github.com/Microsoft/MLOS">MLOS Github Repository</a></p>
</li>
</ul>










</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/MLOS/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Shared Channel Scaleout</strong>

  <label for="toc-control">
    
    <img src="/MLOS/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#benchmark">Benchmark</a></li>
    <li><a href="#results">Results</a>
      <ul>
        <li><a href="#intel-e5-2670-v3--230-ghz">Intel E5-2670 v3 @ 2.30 GHz:</a></li>
        <li><a href="#amd-ryzen-2700x">Amd Ryzen 2700X</a></li>
      </ul>
    </li>
    <li><a href="#improvements">Improvements</a>
      <ul>
        <li><a href="#avoid-creating-proxies-in-the-loop">Avoid creating proxies in the loop</a></li>
        <li><a href="#stdatomic">StdAtomic</a></li>
      </ul>
    </li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="shared-channel-scaleout">Shared Channel Scaleout</h1>
<p>Document contains results of the improvement in the shared communication channel.
We specifically address lack of the scalability issue. The channel does not scale well with increasing number of readers and
writers operating on the same channel instance.</p>
<h2 id="benchmark">Benchmark</h2>
<p>The benchmark is implemented in <em>Mlos.NetCore.Benchmark</em> project</p>
<p>Benchmark:</p>
<blockquote>
<p>$(MLOSROOT)\MLOS\out\obj\Source\Mlos.NetCore.Benchmark\obj\amd64\Mlos.NetCore.Benchmark.exe -i &ndash;filter SharedChannelReaderScaleOutBenchmarks</p>
</blockquote>
<h2 id="results">Results</h2>
<p><strong>Hyper-threading is disabled.</strong></p>
<hr>
<h3 id="intel-e5-2670-v3--230-ghz">Intel E5-2670 v3 @ 2.30 GHz:</h3>
<table>
<thead>
<tr>
<th align="right">ReaderCount</th>
<th align="right">Mean[B]</th>
<th align="right">Mean[I]</th>
<th align="right">Error[B]</th>
<th align="right">Error[I]</th>
<th align="right">StdDev[B]</th>
<th align="right">StdDev[I]</th>
<th align="right">Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">1</td>
<td align="right">830.4 ms</td>
<td align="right">712.9 ms</td>
<td align="right">9.73 ms</td>
<td align="right">5.02 ms</td>
<td align="right">9.10 ms</td>
<td align="right">4.70 ms</td>
<td align="right">3584 B</td>
</tr>
<tr>
<td align="right">2</td>
<td align="right">1,170.8 ms</td>
<td align="right">924.3 ms</td>
<td align="right">3.56 ms</td>
<td align="right">2.88 ms</td>
<td align="right">3.33 ms</td>
<td align="right">2.55 ms</td>
<td align="right">2104 B</td>
</tr>
<tr>
<td align="right">4</td>
<td align="right">1,565.5 ms</td>
<td align="right">1,084.0 ms</td>
<td align="right">1.19 ms</td>
<td align="right">12.20 ms</td>
<td align="right">1.05 ms</td>
<td align="right">11.41 ms</td>
<td align="right">3856 B</td>
</tr>
<tr>
<td align="right">8</td>
<td align="right">2,213.2 ms</td>
<td align="right">1,289.8 ms</td>
<td align="right">2.14 ms</td>
<td align="right">15.75 ms</td>
<td align="right">2.00 ms</td>
<td align="right">14.73 ms</td>
<td align="right">8048 B</td>
</tr>
<tr>
<td align="right">12</td>
<td align="right">4,958.1 ms</td>
<td align="right">1,840.7 ms</td>
<td align="right">13.53 ms</td>
<td align="right">16.53 ms</td>
<td align="right">11.99 ms</td>
<td align="right">15.46 ms</td>
<td align="right">11216 B</td>
</tr>
<tr>
<td align="right">16</td>
<td align="right">7,824.5 ms</td>
<td align="right">1,969.9 ms</td>
<td align="right">13.16 ms</td>
<td align="right">19.01 ms</td>
<td align="right">10.99 ms</td>
<td align="right">15.87 ms</td>
<td align="right">14944 B</td>
</tr>
<tr>
<td align="right">20</td>
<td align="right">8,261.5 ms</td>
<td align="right">2,363.7 ms</td>
<td align="right">21.81 ms</td>
<td align="right">46.70 ms</td>
<td align="right">20.40 ms</td>
<td align="right">53.78 ms</td>
<td align="right">18576 B</td>
</tr>
<tr>
<td align="right">24</td>
<td align="right">8,605.7 ms</td>
<td align="right">2,386.9 ms</td>
<td align="right">42.37 ms</td>
<td align="right">23.49 ms</td>
<td align="right">39.63 ms</td>
<td align="right">21.98 ms</td>
<td align="right">21376 B</td>
</tr>
</tbody>
</table>
<h3 id="amd-ryzen-2700x">Amd Ryzen 2700X</h3>
<table>
<thead>
<tr>
<th>ReaderCount</th>
<th align="right">Mean[B]</th>
<th align="right">Mean[I]</th>
<th align="right">Error[B]</th>
<th align="right">Error[I]</th>
<th align="right">StdDev[B]</th>
<th align="right">StdDev[I]</th>
<th align="right">Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td align="right">541.7 ms</td>
<td align="right">510.1 ms</td>
<td align="right">2.62 ms</td>
<td align="right">8.04 ms</td>
<td align="right">2.32 ms</td>
<td align="right">7.52 ms</td>
<td align="right">2856 B</td>
</tr>
<tr>
<td>2</td>
<td align="right">704.1 ms</td>
<td align="right">526.2 ms</td>
<td align="right">3.03 ms</td>
<td align="right">6.67 ms</td>
<td align="right">2.53 ms</td>
<td align="right">6.24 ms</td>
<td align="right">2064 B</td>
</tr>
<tr>
<td>4</td>
<td align="right">2,724.8 ms</td>
<td align="right">687.1 ms</td>
<td align="right">20.13 ms</td>
<td align="right">13.38 ms</td>
<td align="right">18.83 ms</td>
<td align="right">13.74 ms</td>
<td align="right">3856 B</td>
</tr>
<tr>
<td>8</td>
<td align="right">2,743.6 ms</td>
<td align="right">795.1 ms</td>
<td align="right">22.48 ms</td>
<td align="right">15.40 ms</td>
<td align="right">21.02 ms</td>
<td align="right">18.34 ms</td>
<td align="right">6616 B</td>
</tr>
</tbody>
</table>
<h2 id="improvements">Improvements</h2>
<h3 id="avoid-creating-proxies-in-the-loop">Avoid creating proxies in the loop</h3>
<p>Creating proxy classes (in this example .Sync and .ReadPosition) has a significant cost when the code is running in a tight loop. Before entering the loop, create a proxy structure and access it later inside the loop.</p>
<p>Example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">      readPosition <span style="color:#f92672">=</span> buffer.Sync.ReadPosition.Load();
</code></pre></div><p>Is replaced with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">   MLOSProxy.ChannelSynchronization sync <span style="color:#f92672">=</span> buffer.Sync;
   StdTypesProxy.AtomicUInt32 atomicReadPosition <span style="color:#f92672">=</span> sync.ReadPosition;
   ...
   <span style="color:#66d9ef">int</span> spinIndex <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
   <span style="color:#66d9ef">while</span> (true)
   {
      <span style="color:#75715e">// Wait for the frame become available.
</span><span style="color:#75715e"></span>      <span style="color:#75715e">// Spin on current frame (ReadOffset).
</span><span style="color:#75715e"></span>      <span style="color:#75715e">//
</span><span style="color:#75715e"></span>      readPosition <span style="color:#f92672">=</span> atomicReadPosition.Load();
</code></pre></div><h3 id="stdatomic">StdAtomic</h3>
<p>Removed MemoryBarrier and replaced with Volatile.Read and Volatile.Write.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">   readPosition <span style="color:#f92672">=</span> buffer.Sync.ReadPosition.Load();
...
   Interlocked.MemoryBarrier();
   <span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span>(uint<span style="color:#f92672">*</span>)Buffer.ToPointer();
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">FFB118BC150</span> <span style="color:#ae81ff">50</span>                   <span style="color:#66d9ef">push</span>        <span style="color:#66d9ef">rax</span>
<span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">FFB118BC151</span> <span style="color:#ae81ff">4</span><span style="color:#66d9ef">C</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">D</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">18</span>          <span style="color:#66d9ef">lea</span>         <span style="color:#66d9ef">r8</span>,[<span style="color:#66d9ef">rcx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">18</span><span style="color:#66d9ef">h</span>]
<span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">FFB118BC155</span> <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">B</span> <span style="color:#66d9ef">C0</span>             <span style="color:#66d9ef">mov</span>         <span style="color:#66d9ef">rax</span>,<span style="color:#66d9ef">r8</span>
<span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">FFB118BC158</span> <span style="color:#ae81ff">48</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">B</span> <span style="color:#ae81ff">00</span>             <span style="color:#66d9ef">mov</span>         <span style="color:#66d9ef">rax</span>,<span style="color:#66d9ef">qword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rax</span>]
<span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">FFB118BC15B</span> <span style="color:#66d9ef">F0</span> <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">C</span> <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">00</span>     -<span style="color:#960050;background-color:#1e0010">&gt;</span><span style="color:#66d9ef">lock</span> <span style="color:#66d9ef">or</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rsp</span>],<span style="color:#ae81ff">0</span>
<span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">FFB118BC160</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">B</span> <span style="color:#ae81ff">08</span>             <span style="color:#66d9ef">mov</span>         <span style="color:#66d9ef">r9d</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rax</span>]
<span style="color:#960050;background-color:#1e0010">00007</span><span style="color:#a6e22e">FFB118BC163</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">B</span> <span style="color:#66d9ef">C1</span>             <span style="color:#66d9ef">mov</span>         <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">r9d</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">   MLOSProxy.ChannelSynchronization sync <span style="color:#f92672">=</span> buffer.Sync;
   StdTypesProxy.AtomicUInt32 atomicReadPosition <span style="color:#f92672">=</span> sync.ReadPosition;
...
   readPosition <span style="color:#f92672">=</span> atomicReadPosition.Load();
...
   <span style="color:#66d9ef">return</span> Volatile.Read(ref <span style="color:#f92672">*</span>ptr);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">   <span style="color:#a6e22e">readPosition</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#66d9ef">atomicReadPosition.Load</span>()<span style="color:#75715e">;
</span><span style="color:#75715e"></span>   <span style="color:#ae81ff">00007</span><span style="color:#66d9ef">FFDD883B005</span> <span style="color:#ae81ff">48</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">B</span> <span style="color:#66d9ef">C7</span>             <span style="color:#66d9ef">mov</span>         <span style="color:#66d9ef">rax</span>,<span style="color:#66d9ef">rdi</span>  
   <span style="color:#ae81ff">00007</span><span style="color:#66d9ef">FFDD883B008</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">B</span> <span style="color:#ae81ff">28</span>                <span style="color:#66d9ef">mov</span>         <span style="color:#66d9ef">ebp</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rax</span>]  
   <span style="color:#ae81ff">00007</span><span style="color:#66d9ef">FFDD883B00A</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">B</span> <span style="color:#66d9ef">C5</span>                <span style="color:#66d9ef">mov</span>         <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">ebp</span>  
</code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#benchmark">Benchmark</a></li>
    <li><a href="#results">Results</a>
      <ul>
        <li><a href="#intel-e5-2670-v3--230-ghz">Intel E5-2670 v3 @ 2.30 GHz:</a></li>
        <li><a href="#amd-ryzen-2700x">Amd Ryzen 2700X</a></li>
      </ul>
    </li>
    <li><a href="#improvements">Improvements</a>
      <ul>
        <li><a href="#avoid-creating-proxies-in-the-loop">Avoid creating proxies in the loop</a></li>
        <li><a href="#stdatomic">StdAtomic</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












