<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="MLOS Settings System Code Generation This document provides some documentation on the implementation internals of the MLOS Settings System Code Generation process.
Contents  MLOS Settings System Code Generation  Contents Why code generation? Why custom CodeGen?  Performance Then why not XEvents? Benefits   Build process Classes Hierarchy of CodeWriters  Namespaces   Basic structure generation  CppObjectCodeWriter CppProxyCodeWriter CppEnumCodeWriter   Serialization  Basics Current implementation Alternative CppObjectSerializeCodeWriter CppObjectSerializedLengthCodeWriter   Runtime callback handlers  CppObjectDeserializeRuntimeCallbackCodeWriter CppObjectDeserializeFunctionCallbackCodeWriter   See Also    Why code generation?">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://microsoft.github.io/MLOS/source/Mlos.SettingsSystem.CodeGen/" />

<title>Mlos. Settings System. Code Gen | MLOS</title>
<link rel="manifest" href="/MLOS/manifest.json">
<link rel="icon" href="/MLOS/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/MLOS/book.min.6cd8553a6854f4812343f0f0c8baca31271e686434f381fbe3c7226f66639176.css" integrity="sha256-bNhVOmhU9IEjQ/DwyLrKMSceaGQ084H748cib2ZjkXY=">
<script defer src="/MLOS/en.search.min.62e0f3b3738fddaa64ec8403cf2f470858a16968c72295eda79a95bc0d6fb178.js" integrity="sha256-YuDzs3OP3apk7IQDzy9HCFihaWjHIpXtp5qVvA1vsXg="></script>
<link rel="alternate" type="application/rss+xml" href="https://microsoft.github.io/MLOS/source/Mlos.SettingsSystem.CodeGen/index.xml" title="MLOS" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/MLOS"><span>MLOS</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  <ul>
<li>
<p><a href="/MLOS/documentation/">Documentation</a></p>
<ul>
<li><a href="/MLOS/documentation/01-Prerequisites/">Prerequisites</a></li>
<li><a href="/MLOS/documentation/02-Build/">Build</a></li>
<li><a href="/MLOS/documentation/04-Test/">Test</a></li>
<li><a href="/MLOS/documentation/CodingStandard/">Coding Standard</a></li>
<li><a href="/MLOS/documentation/MlosArchitecture/">Architecture</a></li>
<li><a href="/MLOS/documentation/RepoOrganization/">Repo Organization</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/notebooks/">Notebooks</a></p>
<ul>
<li><a href="/MLOS/notebooks/BayesianOptimization/">Bayesian Optimization</a></li>
<li><a href="/MLOS/notebooks/SmartCacheOptimization/">Smart Cache Optimization</a></li>
<li><a href="/MLOS/notebooks/SmartCacheCPP/">Smart Cache Optimization in C++</a></li>
<li><a href="/MLOS/notebooks/LevelDbTuning/">LevelDB External Tuning Example</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/source/Examples/">E2E Examples</a></p>
<ul>
<li><a href="/MLOS/source/Examples/SmartCache/">Smart Cache</a></li>
</ul>
</li>
<li>
<p>API Documentation</p>
<ul>
<li><a href="/MLOS/python_api/">Python</a></li>
</ul>
</li>
<li>
<p>Component Documentation</p>
<ul>
<li><a href="/MLOS/source/Mlos.SettingsSystem.CodeGen/"class=active>Mlos Settings System Code Generation System</a></li>
<li><a href="/MLOS/source/Mlos.Core/doc/">Mlos.Core Shared Memory Communication Channel</a></li>
<li><a href="/MLOS/source/Mlos.Agent.Server/">Mlos.Agent.Server</a></li>
</ul>
</li>
<li>
<p><a href="/MLOS/external/">External Integration</a></p>
</li>
<li>
<p><a href="/MLOS/CODE_OF_CONDUCT/">Code of Conduct</a></p>
</li>
<li>
<p><a href="/MLOS/CONTRIBUTING/">Contributing</a></p>
</li>
<li>
<p><a href="https://github.com/Microsoft/MLOS">MLOS Github Repository</a></p>
</li>
</ul>










</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/MLOS/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Mlos. Settings System. Code Gen</strong>

  <label for="toc-control">
    
    <img src="/MLOS/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#contents">Contents</a></li>
    <li><a href="#why-code-generation">Why code generation?</a></li>
    <li><a href="#why-custom-codegen">Why custom CodeGen?</a>
      <ul>
        <li><a href="#performance">Performance</a></li>
        <li><a href="#then-why-not-xevents">Then why not XEvents?</a></li>
        <li><a href="#benefits">Benefits</a></li>
      </ul>
    </li>
    <li><a href="#build-process">Build process</a></li>
    <li><a href="#classes">Classes</a></li>
    <li><a href="#hierarchy-of-codewriters">Hierarchy of CodeWriters</a>
      <ul>
        <li><a href="#namespaces">Namespaces</a></li>
      </ul>
    </li>
    <li><a href="#basic-structure-generation">Basic structure generation</a>
      <ul>
        <li><a href="#cppobjectcodewriter">CppObjectCodeWriter</a></li>
        <li><a href="#cppproxycodewriter">CppProxyCodeWriter</a></li>
        <li><a href="#cppenumcodewriter">CppEnumCodeWriter</a></li>
      </ul>
    </li>
    <li><a href="#serialization">Serialization</a>
      <ul>
        <li><a href="#basics">Basics</a></li>
        <li><a href="#current-implementation">Current implementation</a></li>
        <li><a href="#alternative">Alternative</a></li>
        <li><a href="#cppobjectserializecodewriter">CppObjectSerializeCodeWriter</a></li>
        <li><a href="#cppobjectserializedlengthcodewriter">CppObjectSerializedLengthCodeWriter</a></li>
      </ul>
    </li>
    <li><a href="#runtime-callback-handlers">Runtime callback handlers</a>
      <ul>
        <li><a href="#cppobjectdeserializeruntimecallbackcodewriter">CppObjectDeserializeRuntimeCallbackCodeWriter</a></li>
        <li><a href="#cppobjectdeserializefunctioncallbackcodewriter">CppObjectDeserializeFunctionCallbackCodeWriter</a></li>
      </ul>
    </li>
    <li><a href="#see-also">See Also</a></li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="mlos-settings-system-code-generation">MLOS Settings System Code Generation</h1>
<p>This document provides some documentation on the implementation internals of the <a href="https://github.com/microsoft/MLOS/tree/main/source/Mlos.SettingsSystem.CodeGen/">MLOS Settings System Code Generation</a> process.</p>
<h2 id="contents">Contents</h2>
<ul>
<li><a href="#mlos-settings-system-code-generation">MLOS Settings System Code Generation</a>
<ul>
<li><a href="#contents">Contents</a></li>
<li><a href="#why-code-generation">Why code generation?</a></li>
<li><a href="#why-custom-codegen">Why custom CodeGen?</a>
<ul>
<li><a href="#performance">Performance</a></li>
<li><a href="#then-why-not-xevents">Then why not XEvents?</a></li>
<li><a href="#benefits">Benefits</a></li>
</ul>
</li>
<li><a href="#build-process">Build process</a></li>
<li><a href="#classes">Classes</a></li>
<li><a href="#hierarchy-of-codewriters">Hierarchy of CodeWriters</a>
<ul>
<li><a href="#namespaces">Namespaces</a></li>
</ul>
</li>
<li><a href="#basic-structure-generation">Basic structure generation</a>
<ul>
<li><a href="#cppobjectcodewriter">CppObjectCodeWriter</a></li>
<li><a href="#cppproxycodewriter">CppProxyCodeWriter</a></li>
<li><a href="#cppenumcodewriter">CppEnumCodeWriter</a></li>
</ul>
</li>
<li><a href="#serialization">Serialization</a>
<ul>
<li><a href="#basics">Basics</a></li>
<li><a href="#current-implementation">Current implementation</a></li>
<li><a href="#alternative">Alternative</a></li>
<li><a href="#cppobjectserializecodewriter">CppObjectSerializeCodeWriter</a></li>
<li><a href="#cppobjectserializedlengthcodewriter">CppObjectSerializedLengthCodeWriter</a></li>
</ul>
</li>
<li><a href="#runtime-callback-handlers">Runtime callback handlers</a>
<ul>
<li><a href="#cppobjectdeserializeruntimecallbackcodewriter">CppObjectDeserializeRuntimeCallbackCodeWriter</a></li>
<li><a href="#cppobjectdeserializefunctioncallbackcodewriter">CppObjectDeserializeFunctionCallbackCodeWriter</a></li>
</ul>
</li>
<li><a href="#see-also">See Also</a></li>
</ul>
</li>
</ul>
<h2 id="why-code-generation">Why code generation?</h2>
<p>A goal of MLOS is to provide the ability to expose internal application settings, telemetry (metrics, status, etc.), and events to an external agent.</p>
<p>This allows observing and tuning the system with minimal impact on its runtime.</p>
<p>The MLOS code generation process is responsible for generating a set of classes and helper methods to exchange the messages and share (read and update) config structures between the target application and the external agent.
The current mechanism does this using shared memory.</p>
<p>The intended purpose of this is to allow the developer to more succinctly specify the settings and some metadata about them (e.g. default and valid range of values) for use in several different domain specific languages (e.g. C++ for systems code, Python for data science, etc.).</p>
<h2 id="why-custom-codegen">Why custom CodeGen?</h2>
<p>Not <a href="https://developers.google.com/protocol-buffers">Protocol Buffers</a>, <a href="https://google.github.io/flatbuffers/">FlatBuffers</a>, SqlServer XEvents, etc.</p>
<p>The answer is performance and full control.
Emitting the telemetry will occur on the hot path (<em>not always</em>).
We must make sure that we keep code sending the telemetry short and fast as possible.
On SKUs with small CPU count, the telemetry code will extend the critical path.
The ability to recover the application depends (<em>among others</em>) on the exchange framework.</p>
<p>Additionally, some of the existing solutions do not integrate well with some (internal) codebases (e.g. due to use of certain STL features).</p>
<h3 id="performance">Performance</h3>
<p>Interesting benchmarks can be found here <a href="https://github.com/fraillt/cpp_serializers_benchmark">bitsery</a></p>
<table>
<thead>
<tr>
<th>method</th>
<th>data size</th>
<th>serialize</th>
<th>deserialize</th>
</tr>
</thead>
<tbody>
<tr>
<td>bitsery</td>
<td>6913B</td>
<td>1252ms</td>
<td>1170ms</td>
</tr>
<tr>
<td>bitsery_compress</td>
<td>4213B</td>
<td>1445ms</td>
<td>1325ms</td>
</tr>
<tr>
<td>boost</td>
<td>11037B</td>
<td>9952ms</td>
<td>8767ms</td>
</tr>
<tr>
<td>cereal</td>
<td>10413B</td>
<td>6497ms</td>
<td>5470ms</td>
</tr>
<tr>
<td>flatbuffers</td>
<td>14924B</td>
<td>6762ms</td>
<td>2173ms</td>
</tr>
<tr>
<td>yas</td>
<td>10463B</td>
<td>1352ms</td>
<td>1109ms</td>
</tr>
<tr>
<td>yas_compress</td>
<td>7315B</td>
<td>1673ms</td>
<td>1598ms</td>
</tr>
</tbody>
</table>
<h3 id="then-why-not-xevents">Then why not XEvents?</h3>
<p>XEvents generates code responsible for emitting the telemetry; MLOS CodeGen creates both sender and the receiver side.
MLOS CodeGen creates additional code required for shared config lookups.
MLOS CodeGen also allows annotating attributes with additional metadata for data science purposes.</p>
<h3 id="benefits">Benefits</h3>
<ul>
<li>full control over the code, no external dependencies</li>
<li>clean and simple implementation, we are using C# type system (class definitions and attributes) and reflection,</li>
<li>simple, extensible architecture
to add new language support, just add CodeWriters (for example Python Cpp bindings).</li>
<li>easy to integrate with SqlServer (no Cpp standard or open source libraries incompatible with SOS memory management and error handling)</li>
<li>easy to open source (no proprietary dependencies)</li>
</ul>
<h2 id="build-process">Build process</h2>
<p>Codegen works on the types definied in C# assembly. This assembly is called <em>SettingsRegistry</em>. The project definition has a group of files that are included in the code generation workflow.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;ItemGroup</span> <span style="color:#a6e22e">Label=</span><span style="color:#e6db74">&#34;SettingsRegistryDefs&#34;</span><span style="color:#f92672">&gt;</span>
  <span style="color:#75715e">&lt;!--
</span><span style="color:#75715e">      This one uses an assembly level attribute to declare the output
</span><span style="color:#75715e">      namespace for the code.
</span><span style="color:#75715e">  --&gt;</span>
  <span style="color:#f92672">&lt;SettingsRegistryDef</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;Codegen/AssemblyInfo.cs&#34;</span> <span style="color:#f92672">/&gt;</span>
  <span style="color:#75715e">&lt;!--
</span><span style="color:#75715e">      This one defines the settings and message types.
</span><span style="color:#75715e">  --&gt;</span>
  <span style="color:#f92672">&lt;SettingsRegistryDef</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;Codegen/SharedChannelConfig.cs&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/ItemGroup&gt;</span>
<span style="color:#f92672">&lt;ItemGroup&gt;</span>
  <span style="color:#75715e">&lt;!--
</span><span style="color:#75715e">      This one provides the message handler code of those messages for the
</span><span style="color:#75715e">      Mlos.Agent (C#).
</span><span style="color:#75715e">  --&gt;</span>
  <span style="color:#f92672">&lt;Compile</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;AssemblyIntializer.cs&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/ItemGroup&gt;</span>
</code></pre></div><p>First codegen internally compiles files marked as <code>SettingsRegistryDef</code> to a temporary assembly.
From this assembly, codegen uses reflection to discover all the types that are marked with special C# attributes from <code>Mlos.SettingsSystem.Attributes</code> and process the types though a chain of codegen classes.</p>
<p>For instance, a <code>struct</code> may be marked with <code>[CodeGenConfig]</code> (i.e. the <code>CodeGenConfigAttribute</code>) and the settings within it may be marked with <code>[ScalarSetting]</code> (i.e. the <code>ScalarSettingAttribute</code>).</p>
<p>As results codegen produces a series of <code>SettingsProvider_gen_*.*</code> files in <code>out/Mlos.CodeGen.out/</code>.
We can group them (currently) into two categories:</p>
<ol>
<li>
<p>C++ files (<code>.h</code> extension),</p>
</li>
<li>
<p>C# files (<code>.cs</code> extension).</p>
<p>C# files are compiled with other project files into final settings registry assembly.</p>
</li>
</ol>
<p>C++ files are compiled with the client application.</p>
<p><img src="/MLOS/source/Mlos.SettingsSystem.CodeGen/Doc/CodeGenBuild.svg" alt="Settings registry code generation input and output" /></p>
<h2 id="classes">Classes</h2>
<p>CodeGen consist multiple <em>CodeWriter</em> types.
Each <em>CodeWriter</em> is responsible for providing a small subset of functionality.
<em>CodeWriters</em> results are combined into single or multiple files; each <em>CodeWriter</em> specifies the output file as one of its properties.</p>
<h2 id="hierarchy-of-codewriters">Hierarchy of CodeWriters</h2>
<h3 id="namespaces">Namespaces</h3>
<ul>
<li>
<p><code>Mlos.SettingsSystem.CodeGen.CodeWriters.CppTypesCodeWriters</code></p>
<ul>
<li>CodeGens in this namespace write Cpp struct and proxy view definitions.</li>
</ul>
</li>
<li>
<p><code>Mlos.SettingsSystem.CodeGen.CodeWriters.PythonCodeWriters</code></p>
<ul>
<li>Creates python bindings.</li>
</ul>
</li>
<li>
<p><code>Mlos.SettingsSystem.CodeGen.CodeWriters.CppObjectExchangeCodeWriters</code></p>
<ul>
<li>
<p>Creates set of classes and functions that enables exchange generated objects.</p>
<p>This includes helper classes returning type index, serialization and deserialization handlers.</p>
</li>
</ul>
</li>
</ul>
<h2 id="basic-structure-generation">Basic structure generation</h2>
<h3 id="cppobjectcodewriter">CppObjectCodeWriter</h3>
<p>Creates a regular C++ structure based on a C# type.</p>
<p>From the following C# code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-CSharp" data-lang="CSharp"><span style="color:#66d9ef">namespace</span> Mlos.Core.Channel
{
    <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// Shared circular buffer channel settings.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ChannelSettings</span>
    {
        <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>        <span style="color:#75715e">/// Size of the buffer.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">/// To avoid arithmetic overflow, buffer size must be power of two.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> BufferSize;

        <span style="color:#75715e">/// &lt;summary&gt;
</span><span style="color:#75715e"></span>        <span style="color:#75715e">/// Number of reader using this channel.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">/// &lt;/summary&gt;
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> ReaderCount;
    }
}
</code></pre></div><p>From this definition <em>CppObjectCodeWriter</em> generates code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#66d9ef">namespace</span> MLOS
{
<span style="color:#66d9ef">namespace</span> Core
{
<span style="color:#66d9ef">namespace</span> Channel
{
    <span style="color:#75715e">// Shared circular buffer channel settings.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ChannelSettings</span>
    {

        <span style="color:#75715e">// Size of the buffer.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// To avoid arithmetic overflow, buffer size must be power of two.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int32_t</span> BufferSize;

        <span style="color:#75715e">// Number of reader using this channel.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int32_t</span> ReaderCount;
    };
}
}
}
</code></pre></div><p>Note that the code gen output is using C# namespaces.</p>
<h3 id="cppproxycodewriter">CppProxyCodeWriter</h3>
<p>Creates a view to a C++ structure. To be more precise, creates a view to serialized form of the structure.
Allows to read structure fields after they are serialized in the exchange buffer.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#66d9ef">namespace</span> Proxy
{

<span style="color:#66d9ef">namespace</span> MLOS
{
<span style="color:#66d9ef">namespace</span> Core
{
<span style="color:#66d9ef">namespace</span> Channel
{

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ChannelReaderStats</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> PropertyProxy<span style="color:#f92672">&lt;</span>ChannelReaderStats<span style="color:#f92672">&gt;</span>
{
    <span style="color:#66d9ef">typedef</span> <span style="color:#f92672">::</span>MLOS<span style="color:#f92672">::</span>Core<span style="color:#f92672">::</span>Channel<span style="color:#f92672">::</span>ChannelReaderStats RealObjectType;

    ChannelReaderStats(FlatBuffer<span style="color:#f92672">&amp;</span> flatBuffer, <span style="color:#66d9ef">uint32_t</span> offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
     <span style="color:#f92672">:</span>  PropertyProxy<span style="color:#f92672">&lt;</span>ChannelReaderStats<span style="color:#f92672">&gt;</span>(flatBuffer, offset)
    {}
    PropertyProxy<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">&gt;</span> MessagesRead <span style="color:#f92672">=</span> PropertyProxy<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">&gt;</span>(flatBuffer, offset <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span>);
    PropertyProxy<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">&gt;</span> SpinCount <span style="color:#f92672">=</span> PropertyProxy<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">&gt;</span>(flatBuffer, offset <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>);
};

}
}
}

}
</code></pre></div><p>CppProxyCodeWriter creates objects in a <strong>Proxy</strong> namespace, so we can easily distinguish between the structure and its proxy.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++">MLOS<span style="color:#f92672">::</span>Core<span style="color:#f92672">::</span>Channel<span style="color:#f92672">::</span>ChannelReaderStats object;
Proxy<span style="color:#f92672">::</span>MLOS<span style="color:#f92672">::</span>Core<span style="color:#f92672">::</span>Channel<span style="color:#f92672">::</span>ChannelReaderStats proxyView;
</code></pre></div><h3 id="cppenumcodewriter">CppEnumCodeWriter</h3>
<p>Creates a C++ enums. As enum is a primitive type, there is no proxy class for the enum types.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-CSharp" data-lang="CSharp"><span style="color:#66d9ef">enum</span> Colors : <span style="color:#66d9ef">ulong</span>
{
    Red = <span style="color:#ae81ff">2</span>,
    Green = <span style="color:#ae81ff">5</span>,
    Blue = <span style="color:#ae81ff">9</span>
};
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Colors</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">uint64_t</span>
{
    Red <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,
    Green <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>,
    Blue <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>,
};
</code></pre></div><h2 id="serialization">Serialization</h2>
<h3 id="basics">Basics</h3>
<p>Serialization of messages requires a type identifier.
The identifier must be the same for the sender and for the receiver.
The (C++) sender needs to know the type id during compilation, so the function returning the type identifier must use a <code>constexpr</code> modifier.
The receiver uses the type id to find and call proper the handler as a lookup in a dispatch table constructed at compile time.
The (C#) receiver does not need to know type identifier during the compilations and dispatch invocation is always dynamic.</p>
<h3 id="current-implementation">Current implementation</h3>
<p>For each type, CodeGen creates a specialized method <code>TypeMetadataInfo::Index&lt;T&gt;</code> which returns a unique id.
To simplify the dispatcher code, ids are simply type indexes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Cpp" data-lang="Cpp"><span style="color:#66d9ef">namespace</span> TypeMetadataInfo
{
    <span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">uint32_t</span> Index();

    <span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;&gt;</span>
    <span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">uint32_t</span> Index<span style="color:#f92672">&lt;</span>Point<span style="color:#f92672">&gt;</span>() { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">DispatchTableBaseIndex</span>() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; }

    <span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;&gt;</span>
    <span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">uint32_t</span> Index<span style="color:#f92672">&lt;</span>Point3D<span style="color:#f92672">&gt;</span>() { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">DispatchTableBaseIndex</span>() <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>; }

    <span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;&gt;</span>
    <span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">uint32_t</span> Index<span style="color:#f92672">&lt;</span>Line<span style="color:#f92672">&gt;</span>() { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">DispatchTableBaseIndex</span>() <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>; }
    ...
}
</code></pre></div><p>The CodeGen is creating a dispatcher table:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Cpp" data-lang="Cpp">
<span style="color:#66d9ef">__declspec</span>(selectany) <span style="color:#f92672">::</span>MLOS<span style="color:#f92672">::</span>Core<span style="color:#f92672">::</span>DispatchEntry DispatchTable[] <span style="color:#f92672">=</span>
   {
       <span style="color:#f92672">::</span>MLOS<span style="color:#f92672">::</span>Core<span style="color:#f92672">::</span>DispatchEntry
       {
           TypeMetadataInfo<span style="color:#f92672">::</span>Index<span style="color:#f92672">&lt;::</span>SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>Point<span style="color:#f92672">&gt;</span>(),
           [](<span style="color:#f92672">/</span>MLOS<span style="color:#f92672">/</span>source<span style="color:#f92672">/</span>Mlos.SettingsSystem.CodeGen<span style="color:#f92672">/</span>FlatBuffer<span style="color:#f92672">&amp;&amp;</span> buffer)
           {
               Proxy<span style="color:#f92672">::</span>SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>Point recvObjectProxy(buffer);
               ObjectDeserializationCallback<span style="color:#f92672">::</span>Deserialize(std<span style="color:#f92672">::</span>move(recvObjectProxy));
           }
       }
       ...
   }
</code></pre></div><p>Because we are using type indexes, finding a dispatcher routine is a matter of simple table lookup.
To verify if the sender and receiver processes are using the same table, the sender will  include the hash created from the type definition.
That allows receiver to reject invalid/type mismatched frames.</p>
<p>Special steps are required to enable usage of multiple dispatch tables.
Each dispatch table must have a unique base index.
All type indexes included in this dispatch table will be incremented by the base table index.
Base index of next dispatch table is equal to base index of the previous table plus number of types of previous table.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Cpp" data-lang="Cpp"><span style="color:#75715e">// Base indexes for all included dispatcher tables.
</span><span style="color:#75715e">//
</span><span style="color:#75715e"></span><span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">uint32_t</span> MLOS<span style="color:#f92672">::</span>Core<span style="color:#f92672">::</span>Channel<span style="color:#f92672">::</span>ObjectDeserializationHandler<span style="color:#f92672">::</span>DispatchTableBaseIndex()
{
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
<span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">uint32_t</span> SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>ObjectDeserializationHandler<span style="color:#f92672">::</span>DispatchTableBaseIndex()
{
    <span style="color:#66d9ef">return</span> MLOS<span style="color:#f92672">::</span>Core<span style="color:#f92672">::</span>Channel<span style="color:#f92672">::</span>ObjectDeserializationHandlerHandler<span style="color:#f92672">::</span>DispatchTableElementCount();
}
</code></pre></div><p>The global dispatch table (a concatenation of all included dispatch tables) is created as a compile time constant for efficiency.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Cpp" data-lang="Cpp"><span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">auto</span> <span style="color:#a6e22e">GlobalDispatchTable</span>()
{
    <span style="color:#66d9ef">auto</span> globalDispatchTable <span style="color:#f92672">=</span> MLOS<span style="color:#f92672">::</span>Core<span style="color:#f92672">::</span>DispatchTable<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span>()
        .concatenate(MLOS<span style="color:#f92672">::</span>Core<span style="color:#f92672">::</span>Channel<span style="color:#f92672">::</span>ObjectDeserializationHandler<span style="color:#f92672">::</span>DispatchTable)
        .concatenate(SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>ObjectDeserializationHandler<span style="color:#f92672">::</span>DispatchTable);

    <span style="color:#66d9ef">return</span> globalDispatchTable;
}
</code></pre></div><h3 id="alternative">Alternative</h3>
<p>Use type hash as identifier.
Receiver would need to perform a lookup (e.g. hashmap, if/else sequence, binary search, binary search with if/else sequence) to find the correct dispatch function.</p>
<p>TODO: <em>revisit after implementing C# dispatch handlers</em></p>
<h3 id="cppobjectserializecodewriter">CppObjectSerializeCodeWriter</h3>
<h3 id="cppobjectserializedlengthcodewriter">CppObjectSerializedLengthCodeWriter</h3>
<p>&hellip;
&hellip; TODO
&hellip; more documentation needs to go here
&hellip;</p>
<h2 id="runtime-callback-handlers">Runtime callback handlers</h2>
<p>Runtime callback handlers allow the developer to dynamically change the callback code.</p>
<h3 id="cppobjectdeserializeruntimecallbackcodewriter">CppObjectDeserializeRuntimeCallbackCodeWriter</h3>
<p>For each type, codegen will generate a callback that can be set in runtime.
The root callback namespace is <em>ObjectDeserializationCallback</em>, callbacks for types are created in type specific namespace.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Cpp" data-lang="Cpp"><span style="color:#66d9ef">namespace</span> ObjectDeserializationCallback
{
    <span style="color:#66d9ef">namespace</span> _Type_Namespace_
    {
    <span style="color:#66d9ef">__declspec</span>(selectany) std<span style="color:#f92672">::</span>function<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span> (<span style="color:#f92672">::</span>Proxy<span style="color:#f92672">::</span>SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>Point<span style="color:#f92672">&amp;&amp;</span>)<span style="color:#f92672">&gt;</span> Point_Callback <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
    <span style="color:#66d9ef">__declspec</span>(selectany) std<span style="color:#f92672">::</span>function<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span> (<span style="color:#f92672">::</span>Proxy<span style="color:#f92672">::</span>SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>Point3D<span style="color:#f92672">&amp;&amp;</span>)<span style="color:#f92672">&gt;</span> Point3D_Callback <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
    ...
    }
}
</code></pre></div><p>Here is an example of setting runtime callback, test code is verifying the received object.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Cpp" data-lang="Cpp">ObjectDeserializationCallback<span style="color:#f92672">::</span>SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>Point_Callback <span style="color:#f92672">=</span> [point](Proxy<span style="color:#f92672">::</span>SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>Point<span style="color:#f92672">&amp;&amp;</span> recvPoint)
{
    <span style="color:#66d9ef">float</span> x <span style="color:#f92672">=</span> recvPoint.x;
    <span style="color:#66d9ef">float</span> y <span style="color:#f92672">=</span> recvPoint.y;

    EXPECT_EQ(point.x, x);
    EXPECT_EQ(point.y, y);
};
</code></pre></div><h3 id="cppobjectdeserializefunctioncallbackcodewriter">CppObjectDeserializeFunctionCallbackCodeWriter</h3>
<p>CodeGen will generate a set of handlers with a default action to call proper callback.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Cpp" data-lang="Cpp"><span style="color:#66d9ef">namespace</span> ObjectDeserializationCallback
{
    <span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;&gt;</span>
    <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> Deserialize<span style="color:#f92672">&lt;::</span>Proxy<span style="color:#f92672">::</span>SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>Point<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">::</span>Proxy<span style="color:#f92672">::</span>SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>Point<span style="color:#f92672">&amp;&amp;</span> obj)
    {
        <span style="color:#f92672">::</span>ObjectDeserializationCallback<span style="color:#f92672">::</span>SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>Point_Callback(std<span style="color:#f92672">::</span>move(obj));
    }

    <span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;&gt;</span>
    <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> Deserialize<span style="color:#f92672">&lt;::</span>Proxy<span style="color:#f92672">::</span>SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>Point3D<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">::</span>Proxy<span style="color:#f92672">::</span>SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>Point3D<span style="color:#f92672">&amp;&amp;</span> obj)
    {
        <span style="color:#f92672">::</span>ObjectDeserializationCallback<span style="color:#f92672">::</span>SqlServer<span style="color:#f92672">::</span>Spatial<span style="color:#f92672">::</span>Point3D_Callback(std<span style="color:#f92672">::</span>move(obj));
    }
</code></pre></div><p>There is performance overhead related to a <code>std::function</code> call.
However runtime callbacks provide great flexibility and allow runtime
changing the callback handlers.
Therefore, we envision the primary usage for runtime handlers is testing.</p>
<h2 id="see-also">See Also</h2>
<ul>
<li><a href="/MLOS/source/Mlos.SettingsSystem.CodeGen/../Mlos.SettingsSystem.Attributes/">Mlos Settings System Attributes</a></li>
<li><a href="/MLOS/source/Mlos.SettingsSystem.CodeGen/../Examples/SmartCache/">Smart Cache C++ Example</a></li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#contents">Contents</a></li>
    <li><a href="#why-code-generation">Why code generation?</a></li>
    <li><a href="#why-custom-codegen">Why custom CodeGen?</a>
      <ul>
        <li><a href="#performance">Performance</a></li>
        <li><a href="#then-why-not-xevents">Then why not XEvents?</a></li>
        <li><a href="#benefits">Benefits</a></li>
      </ul>
    </li>
    <li><a href="#build-process">Build process</a></li>
    <li><a href="#classes">Classes</a></li>
    <li><a href="#hierarchy-of-codewriters">Hierarchy of CodeWriters</a>
      <ul>
        <li><a href="#namespaces">Namespaces</a></li>
      </ul>
    </li>
    <li><a href="#basic-structure-generation">Basic structure generation</a>
      <ul>
        <li><a href="#cppobjectcodewriter">CppObjectCodeWriter</a></li>
        <li><a href="#cppproxycodewriter">CppProxyCodeWriter</a></li>
        <li><a href="#cppenumcodewriter">CppEnumCodeWriter</a></li>
      </ul>
    </li>
    <li><a href="#serialization">Serialization</a>
      <ul>
        <li><a href="#basics">Basics</a></li>
        <li><a href="#current-implementation">Current implementation</a></li>
        <li><a href="#alternative">Alternative</a></li>
        <li><a href="#cppobjectserializecodewriter">CppObjectSerializeCodeWriter</a></li>
        <li><a href="#cppobjectserializedlengthcodewriter">CppObjectSerializedLengthCodeWriter</a></li>
      </ul>
    </li>
    <li><a href="#runtime-callback-handlers">Runtime callback handlers</a>
      <ul>
        <li><a href="#cppobjectdeserializeruntimecallbackcodewriter">CppObjectDeserializeRuntimeCallbackCodeWriter</a></li>
        <li><a href="#cppobjectdeserializefunctioncallbackcodewriter">CppObjectDeserializeFunctionCallbackCodeWriter</a></li>
      </ul>
    </li>
    <li><a href="#see-also">See Also</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












